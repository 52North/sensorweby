var Permalink={getUrlParameter:function(a){for(var b=window.location.search,b=b.substring(b.indexOf("?")+1),b=b.split("\x26"),c=0;c<b.length;c++){var d=b[c].split("\x3d");if(d[0]==a)return decodeURIComponent(d[1])}}},i18n={};function _(a){var b=Permalink.getUrlParameter("lang")||navigator.language||navigator.userLanguage,b=readI18n(b,a)||readI18n("en",a);return $.isEmptyObject(b)?a:b}
function readI18n(a,b){try{var c=b.split("."),d=i18n[a];if(!d){var e=a.split("-"),d=i18n[e[0]+"_"+e[1]];!d&&1<e.length&&(d=i18n[e[0]])}for(;c.length;)var f=c.splice(0,1),d=read_prop(d,f[0]);$.isEmptyObject(d)&&console.error("Missing i18n key '"+b+"' for language "+a);return d}catch(g){console.error("Don't find the i18n key '"+b+"' for language "+a)}}function read_prop(a,b){return a[b]}
i18n.en={ok:"OK",main:{legend:"Legend",diagram:"Diagram",mapView:"Map view",settings:"Settings",stationSelection:"Select a station",chartView:"Chart view",phenomena:"Phenomena",phenomenon:"Phenomenon",favoritesList:"Favorites",importFavorites:"Import",exportFavorites:"Export",importExportHelp:"Choose a file to import or export favorites",noFileSelected:"No file selected"},chart:{noTimeseriesSelected:"You have selected no timeseries or the selected timeseries have no values in the given time range.",
outsideOfDataRange:"Outside of data range!"},map:{userLocation:"Here is your current location",stationSelection:{station:"Station",selectAllTimeseries:"select all timeseries"},stationLocation:{station:"Station",timeseries:"Timeseries",provider:"Provider"},providerList:{provider:"Provider",stations:"Stations",timeseries:"Timeseries",phenomena:"Phenomena"},search:{label:"search for address ...",noResult:"Sorry, that address could not be found."}},listSelection:{header:"Select timeseries by list",headers:{category:"Category",
station:"Station",phenomenon:"Phenomenon",procedure:"Sensor"},warning:{moreThanOneTimeseries:"found more than one timeseries"}},legend:{entry:{noData:"no Data available",jumpToLastValue:"jump to last value",firstValueAt:"First value at",lastValueAt:"Last value at"}},"export":{label:"get data as CSV-File"},timeSelection:{header:"Time Range",presetsHeader:"presets",presets:{lastHour:"last hour",today:"today",yesterday:"yesterday",todayYesterday:"today \x26 yesterday",thisWeek:"this week",lastWeek:"last week",
thisMonth:"this month",lastMonth:"last month",thisYear:"this year",lastYear:"last year"},custom:{header:"custom",start:"Start date",end:"End date"},warning:{startBeforeEnd:"The start date can not be greater then the end date",maxTimeRange:"The time range can not be greater then one year"}},styleChange:{header:"Change style",currentColor:"Current color",selectColor:"Select a new color",selectBarInterval:"Select the bar interval",barChartInterval:{hour:"Hour",day:"Day",week:"Week",month:"Month"},zeroScaled:"zero scaled Y-axis",
groupedAxis:"grouped axis"},settings:{header:"Settings",resetStatus:"Reset status",permalink:{create:"Create a permalink as",inWindow:"link in a new window",inMail:"link in an email",inClipboard:"Link to clipboard",clipboardInfo:"Copy to clipboard: Ctrl+C, Enter",inQrCode:"as QR-Code",favorite:"Status as favorite entry"},clusterMarker:"cluster marker",markerWithLastInfo:{header:"marker with last value information",label:"attention - some data provider are very slow"},saveStatus:"save status",generalizeData:"generalize Data",
imprint:{header:"Imprint",github:'Find this project at \x3ca href\x3d"https://github.com/52North/js-sensorweb-client" target\x3d"_blank"\x3eGitHub\x3c/a\x3e',text:'\x3cp\x3e\x3ca href\x3d"http://52north.org" target\x3d"_blank"\x3e52\x26deg;North GmbH\x3c/a\x3e is responsible for this website.\x3c/p\x3e\x3cp\x3e52\x26deg;North Initiative for Geospatial Open Source Software GmbH\x3cbr\x3eMartin-Luther-King-Weg 24\x3cbr\x3e48155 Muenster, Germany\x3c/p\x3e'}},permalink:{noMatchingTimeseriesFound:"No matching timeseries is found."},
guide:{step1:{header:"JavaScript Client - Guided Tour",text:"This tour gives in a few steps an overview how to use this client. First we add a timeseries from the map."},step2:{header:"Go to the map",text:"Here we switch the view to get a map."},step3:{header:"Map view",text:"This is the map view. In the map you can see markers or markergroups."},step4:{header:"Change Provider",text:"Here you can select another timeseries provider."},step5:{header:"Show location",text:"And here you can locate your device on the map."},
step6:{header:"List selection",text:"Here you can select a timeseries out of ordered lists."},step7:{header:"Select a station",text:"Please select now a station on the map."},step8:{header:"Select timeseries",text:'Select this checkbox. If there is only one timeseries for this station, the checkbox is already checked. Now you can go on with the "OK" button to load the timeseries.'},step9:{header:"Legend entry",text:"Here you see the added time series. You can delete or locate the time series or change the color."},
step10:{header:"Chart",text:"This is the chart of the selected time series."},step11:{header:"Change time",text:"Here you can change the time extent for your selected time series."},step12:{header:"Table View",text:"Here you get a table of the raw data values to your selected time series."},step13:{header:"Favorite management",text:"The legend entries/timeseries could be saved as favorites. In this view all favorites are listed and could be maintained."},step14:{header:"Finished",text:'Well done!\x3cbr\x3e This client is a product of \x3ca href\x3d"http://52north.org" target\x3d"_blank"\x3e52\x26deg;North GmbH\x3c/a\x3e. You can find the source code on \x3ca href\x3d"https://github.com/52North/js-sensorweb-client" target\x3d"_blank"\x3eGitHub\x3c/a\x3e.'}},
favorite:{firstValueAt:"First value at",lastValueAt:"Last value at",edit:{header:"Edit favorite"},group:{add:"The status '{0}' is added to the favorite list.",exists:"This status still exists.",noTimeseries:"Currently no timeseries are selected.",notSupported:"The provider of an entry of the status '{0}' isn't supported and can't be loaded."},single:{add:"A new favorite '{0}' is added to the list.",remove:"The favorite '{0}' is removed.",exists:"This favorite still exists.",notSupported:"The provider of the favorite '{0}' isn't supported and can't be loaded."}},
inform:{error:"An error occured: ",warn:"Please remember that: "}};
i18n.en_GB={ok:"OK",main:{legend:"Legend",diagram:"Diagram",mapView:"Map view",settings:"Settings",stationSelection:"Select a station",chartView:"Chart view",phenomena:"Phenomena",phenomenon:"Phenomenon",favoritesList:"Favourites"},chart:{noTimeseriesSelected:"You have selected no timeseries or the selected timeseries have no values in the given time range.",outsideOfDataRange:"Outside of data range!"},map:{userLocation:"Here is your current location",stationSelection:{station:"Station",selectAllTimeseries:"select all timeseries"},
stationLocation:{station:"Station",timeseries:"Timeseries",provider:"Provider"},providerList:{provider:"Provider",stations:"Stations",timeseries:"Timeseries",phenomena:"Phenomena"},search:{label:"search for address ...",noResult:"Sorry, that address could not be found."}},listSelection:{header:"Select timeseries by list",headers:{category:"Category",station:"Station",phenomenon:"Phenomenon",procedure:"Sensor"},warning:{moreThanOneTimeseries:"found more than one timeseries"}},legend:{entry:{noData:"no Data available",
jumpToLastValue:"jump to last value",firstValueAt:"First value at",lastValueAt:"Last value at"}},"export":{label:"get data as CSV-File"},timeSelection:{header:"Time Range",presetsHeader:"presets",presets:{today:"today",yesterday:"yesterday",todayYesterday:"today \x26 yesterday",thisWeek:"this week",lastWeek:"last week",thisMonth:"this month",lastMonth:"last month",thisYear:"this year",lastYear:"last year"},custom:{header:"custom",start:"Start date",end:"End date"},warning:{startBeforeEnd:"The start date can not be greater then the end date",
maxTimeRange:"The time range can not be greater then one year"}},styleChange:{header:"Change style",currentColor:"Current color",selectColor:"Select a new color",selectBarInterval:"Select the bar interval",barChartInterval:{hour:"Hour",day:"Day",week:"Week",month:"Month"},zeroScaled:"zero scaled Y-axis",groupedAxis:"grouped axis"},settings:{header:"Settings",resetStatus:"Reset status",permalink:{create:"Create a permalink as:",inWindow:"link in a new window",inMail:"link in an email",inClipboard:"Link to clipboard",
clipboardInfo:"Copy to clipboard: Ctrl+C, Enter",inQrCode:"as QR-Code",favorite:"Status as favourite entry"},clusterMarker:"cluster marker",markerWithLastInfo:{header:"marker with last value information",label:"attention - some data provider are very slow"},saveStatus:"save status",generalizeData:"generalize Data",imprint:{header:"Imprint",github:'Find this project at \x3ca href\x3d"https://github.com/52North/js-sensorweb-client" target\x3d"_blank"\x3eGitHub\x3c/a\x3e',text:'\x3cp\x3e\x3ca href\x3d"http://52north.org" target\x3d"_blank"\x3e52\x26deg;North GmbH\x3c/a\x3e is responsible for this website.\x3c/p\x3e\x3cp\x3e52\x26deg;North Initiative for Geospatial Open Source Software GmbH\x3cbr\x3eMartin-Luther-King-Weg 24\x3cbr\x3e48155 Muenster, Germany\x3c/p\x3e'}},
permalink:{noMatchingTimeseriesFound:"No matching timeseries is found."},guide:{step1:{header:"JavaScript Client - Guided Tour",text:"This tour gives in a few steps an overview how to use this client. First we add a timeseries from the map."},step2:{header:"Go to the map",text:"Here we switch the view to get a map."},step3:{header:"Map view",text:"This is the map view. In the map you can see markers or markergroups."},step4:{header:"Change Provider",text:"Here you can select another timeseries provider."},
step5:{header:"Show location",text:"And here you can locate your device on the map."},step6:{header:"List selection",text:"Here you can select a timeseries out of ordered lists."},step7:{header:"Select a station",text:"Please select now a station on the map."},step8:{header:"Select timeseries",text:'Select this checkbox. If there is only one timeseries for this station, the checkbox is already checked. Now you can go on with the "OK" button to load the timeseries.'},step9:{header:"Legend entry",text:"Here you see the added time series. You can delete or locate the time series or change the color."},
step10:{header:"Chart",text:"This is the chart of the selected time series."},step11:{header:"Change time",text:"Here you can change the time extent for your selected time series."},step12:{header:"Table View",text:"Here you get a table of the raw data values to your selected time series."},step13:{header:"Favourite management",text:"The legend entries/timeseries could be saved as favourites. In this view all favourites are listed and could be maintained."},step14:{header:"Finished",text:'Well done!\x3cbr\x3e This client is a product of \x3ca href\x3d"http://52north.org" target\x3d"_blank"\x3e52\x26deg;North GmbH\x3c/a\x3e. You can find the source code on \x3ca href\x3d"https://github.com/52North/js-sensorweb-client" target\x3d"_blank"\x3eGitHub\x3c/a\x3e.'}},
favorite:{firstValueAt:"First value at",lastValueAt:"Last value at",edit:{header:"Edit favourite"},group:{add:"The status '{0}' is added to the favourite list.",exists:"This status still exists.",noTimeseries:"Currently no timeseries are selected.",notSupported:"The provider of an entry of the status '{0}' isn't supported and can't be loaded."},single:{add:"A new favourite '{0}' is added to the list.",remove:"The favourite '{0}' is removed.",exists:"This favourite still exists.",notSupported:"The provider of the favourite '{0}' isn't supported and can't be loaded."}},
inform:{error:"An error occured: ",warn:"Please remember that: "}};
i18n.de={ok:"OK",main:{legend:"Legende",diagram:"Diagramm",mapView:"Kartenansicht",settings:"Einstellungen",stationSelection:"Wähle eine Station aus",chartView:"Diagrammansicht",phenomena:"Phänomene",phenomenon:"Phänomen",favoritesList:"Favoriten",importFavorites:"Importieren",exportFavorites:"Exportieren",importExportHelp:"Datei für den Im- oder Exportieren wählen",noFileSelected:"Keine Datei ausgewählt"},chart:{noTimeseriesSelected:"Sie haben keine Zeitreihe ausgewählt oder die gewählten Zeitreihen haben keine Werte in dem derzeitigen Zeitraum.",outsideOfDataRange:"Außerhalb des Datenbereichs!"},
map:{userLocation:"Hier ist ihr Standort",stationSelection:{station:"Station",selectAllTimeseries:"wähle alle Zeitreihen"},stationLocation:{station:"Station",timeseries:"Zeitreihe",provider:"Datenanbieter"},providerList:{provider:"Datenanbieter",stations:"Stationen",timeseries:"Zeitreihen",phenomena:"Phänomene"},search:{label:"suche Addresse ...",noResult:"Sorry, es konnte keine Adresse gefunden werden."}},listSelection:{header:"Listenbasierte Zeitreihenauswahl",headers:{category:"Kategorie",station:"Station",
phenomenon:"Phänomen",procedure:"Sensor"},warning:{moreThanOneTimeseries:"Mehr als eine Zeitreihe gefunden"}},legend:{entry:{noData:"keine Daten verfügbar",jumpToLastValue:"Springe zur letzten Messung",firstValueAt:"Erster Wert bei",lastValueAt:"Letzter Wert bei"}},"export":{label:"Daten als CSV-File"},timeSelection:{header:"Zeitraum",presetsHeader:"Vordefiniert",presets:{lastHour:"letzte Stunde",today:"heute",yesterday:"gestern",todayYesterday:"heute \x26 gestern",thisWeek:"diese Woche",lastWeek:"letzte Woche",
thisMonth:"diesen Monat",lastMonth:"letzten Monat",thisYear:"dieses Jahr",lastYear:"letztes Jahr"},custom:{header:"Freidefiniert",start:"Startzeitpunkt",end:"Endzeitpunkt"},warning:{startBeforeEnd:"Der Startzeitpunkt darf nicht größer als der Endzeitpunkt sein",maxTimeRange:"Der ausgewählte Zeitraum darf nicht größer als ein Jahr sein"}},styleChange:{header:"Ändern der Zeitreihengestaltung",currentColor:"Derzeitige Farbe",selectColor:"Wähle neue Farbe",selectBarInterval:"Wähle Balkeninterval",barChartInterval:{hour:"Stunde",
day:"Tag",week:"Woche",month:"Monat"},zeroScaled:"Nullbasierte Y-Achse",groupedAxis:"gruppierte Achse"},settings:{header:"Einstellungen",resetStatus:"Lösche den Status",permalink:{create:"Erstelle Permalink",inWindow:"öffnen im neuen Fenster",inMail:"öffnen in leerer Mail",inClipboard:"Link in die Zwischenablage",clipboardInfo:"Kopiere in die Zwischenablage: Ctrl+C, Enter",inQrCode:"als QR-Code",favorite:"Status in die Favoritenliste übernehmen"},clusterMarker:"Marker gruppieren",markerWithLastInfo:{header:"Marker mit Wert der letzten Messung",
label:"Achtung - dies kann bei einigen Providern zu langen Afragen führen"},saveStatus:"Status mitzeichnen",generalizeData:"Daten generalisiert abfragen",imprint:{header:"Impressum",github:'Zur \x3ca href\x3d"https://github.com/52North/js-sensorweb-client" target\x3d"_blank"\x3eGitHub\x3c/a\x3e-Seite dieses Projekts',text:'\x3cp\x3e\x3ca href\x3d"http://52north.org" target\x3d"_blank"\x3e52\x26deg;North GmbH\x3c/a\x3e ist für diese Website verantwortlich.\x3c/p\x3e\x3cp\x3e52\x26deg;North Initiative for Geospatial Open Source Software GmbH\x3cbr\x3eMartin-Luther-King-Weg 24\x3cbr\x3e48155 Muenster, Deutschland\x3c/p\x3e'}},
permalink:{noMatchingTimeseriesFound:"Keine passende Zeitreihe gefunden."},guide:{step1:{header:"JavaScript Client - Geführte Tour",text:"Die Tour gibt in ein paar Schritten einen Überblick über den Client. Zuerst fügen wir eine Zeitreihe von der Karte hinzu."},step2:{header:"Zur Karte",text:"Hier kann man die zur Kartenansicht wechseln."},step3:{header:"Karten Ansicht",text:"In der Karte siehst du die Stationen als Marker oder Markergruppen."},step4:{header:"Änder den Datenanbieter",text:"Hier kannst du aus einer Liste von Datenanbieter auswählen."},
step5:{header:"Eigene Position",text:"Hier kannst du dich lokalisieren lassen."},step6:{header:"Listenauswahl",text:"Hier ist einen Zeitreihenauswahl durch geortnete Listen möglich."},step7:{header:"Auswahl einer Station",text:"Bitte wähle eine Station auf der Karte aus."},step8:{header:"Zeitreihe auswählen",text:"Wähle einen Zeitreihe durch anklicken der Checkbox. Liegt an dieser Station nur eine Zeitreihe vor, ist diese direkt angewählt. Durch klicken des OK-Buttons wird die Zeitreihe eingeladen."},
step9:{header:"Legendeneintrag",text:"Hier wird die zugefügte Zeitreihe angezeigt. Du kannst die Zeitreihe hier wieder entfernen oder den Style ändern."},step10:{header:"Diagramm",text:"Dies ist das Diagramm der gewählten Zeitreihen."},step11:{header:"Zeit ändern",text:"Hier kann der Zeitraum angepasst werden."},step12:{header:"Tabellenansicht",text:"Hier bekommt man die Rohdaten in einer Tabelle präsentiert."},step13:{header:"Favoritenverwaltung",text:"Die Legendeneinträge/Zeitreihen können als Favoriten abgespeichert werden. Hier werden alle Favoriten gelistet und können verwaltet werden."},
step14:{header:"Fertig",text:'Super!\x3cbr\x3e Dieser Client ist ein Produkt von \x3ca href\x3d"http://52north.org" target\x3d"_blank"\x3e52\x26deg;North GmbH\x3c/a\x3e. Auf \x3ca href\x3d"https://github.com/52North/js-sensorweb-client" target\x3d"_blank"\x3eGitHub\x3c/a\x3e findest du den aktuellen Entwicklungsstand.'}},favorite:{firstValueAt:"Erster Wert bei",lastValueAt:"Letzter Wert bei",edit:{header:"Favorit editieren"},group:{add:"Der Status wird mit dem Name '{0}' in den Favoriten abgelegt.",
noTimeseries:"Derzeit sind keine Zeitreihen ausgewählt.",exists:"Dieser Status existiert bereits.",notSupported:"Der Datenanbieter eines Eintrag aus '{0}' wird nicht unterstützt und kann deswegen nicht eingeladen werden."},single:{add:"Einer neuer Favorit mit dem Name '{0}' ist abgelegt worden.",remove:"Der Favorit '{0}' ist entfernt worden.",exists:"Dieser Favorit existiert bereits.",notSupported:"Der Datenanbieter des Favoriten '{0}' wird nicht unterstützt und kann deswegen nicht eingeladen werden."}},
inform:{error:"Ein Fehler ist aufgetreten: ",warn:"Bitte beachten Sie: "}};
function TimeSeries(a,b,c){var d=tsHelper.createInternalId(a,c),e=[],f={},g=!1,m=Settings.defaultZeroScale,h=Settings.defaultGroupedAxis,k=Settings.timeseriesDataBuffer||moment.duration(2,"h");$.each(b.referenceValues,$.proxy(function(a,b){f[b.referenceValueId]=new ReferenceValue(b.referenceValueId,b.label)},this));var l={},l=b.hasOwnProperty("renderingHints")?new TimeseriesStyle(b.renderingHints.chartType,b.renderingHints.properties.width,b.renderingHints.properties.color,b.renderingHints.properties.interval,
b.renderingHints.properties.type):TimeseriesStyle.createDefault(a);this.getTsId=function(){return a};this.getInternalId=function(){return d};this.getApiUrl=function(){return c};this.getStyle=function(){return l};this.isZeroScaled=function(){return m};this.setZeroScaled=function(a){m=a};this.isGroupedAxis=function(){return h};this.setGroupedAxis=function(a){h=a};this.isSynced=function(){return g};this.getUom=function(){return b.uom};this.getLabel=function(){return b.label};this.unSynced=function(){g=
!1};this.getValues=function(){return e};this.getLastValue=function(){return b&&b.lastValue?b.lastValue:null};this.isCurrent=function(){return null!=this.getLastValue()&&moment().subtract(Settings.ignoreAfterDuration).isBefore(moment(this.getLastValue().timestamp))};this.getLastValueFormatted=function(){return b&&b.lastValue?b.lastValue.value+" "+b.uom+" ("+moment(b.lastValue.timestamp).format(Settings.dateformat)+")":null};this.getFirstValue=function(){return b&&b.firstValue?b.firstValue:null};this.getFirstValueFormatted=
function(){return b&&b.firstValue?b.firstValue.value+" "+b.uom+" ("+moment(b.firstValue.timestamp).format(Settings.dateformat)+")":null};this.getCoordinates=function(){return b.station.geometry.coordinates};this.getStationId=function(){return b.station.properties.id};this.getStationLabel=function(){return b.station.properties.label};this.getServiceLabel=function(){return b.parameters.service.label};this.getPhenomenonLabel=function(){return b.parameters.phenomenon.label};this.getProcedureLabel=function(){return b.parameters.procedure.label};
this.getCategoryLabel=function(){return b.parameters.category&&b.parameters.phenomenon.label!=b.parameters.category.label?b.parameters.category.label:""};this.getStatusIntervals=function(){return b.statusIntervals};this.hasData=function(){return 0!=e.length};this.getRefValuesForId=function(a){return f.hasOwnProperty(a)?f[a]:[]};this.getRefValues=function(a){return f};this.persist=function(){return{style:l.persist(),apiUrl:c,tsId:a}};this.fetchData=function(b,e){var f=moment(b.from).subtract(k),g=
moment(b.till).add(k);b=Time.getRequestTimespan(f,g);this.promise=Rest.tsData(a,c,b,d);this.promise.done($.proxy(this.fetchedDataFinished,{context:this,complete:e}));return this.promise};this.fetchedDataFinished=function(a,b){this.context.createTimeBuffer(a);e=a;$.each(b,function(a,b){f[a]&&f[a].setValues(b)});g=!0;this.complete(this.context)};this.createTimeBuffer=function(a){2<=a.length&&(k=moment.duration(a[1][0]-a[0][0]))};this.destroy=function(){this.promise.reject(d)}}
function ReferenceValue(a,b){var c=Color.stringToColor(a),d=[],e=!1;this.getId=function(){return a};this.getLabel=function(){return b};this.getColor=function(){return c};this.getValues=function(){return d};this.setValues=function(a){d=a};this.isSelected=function(){return e};this.selected=function(a){e=a}}
function TimeseriesStyle(a,b,c,d,e){createInterval=function(a){switch(a){case "byHour":return 1;case "byDay":return 24;case "byWeek":return 168;case "byMonth":return 720;default:return 1}};var f=createInterval(d);this.getColor=function(){return c};this.setColor=function(a){c=a};this.getChartType=function(){return a};this.setChartType=function(b){a=b};this.isBarChart=function(){return"bar"==a};this.isLineChart=function(){return"line"==a};this.getIntervalByHours=function(){return f};this.getLineType=
function(){return e};this.getWidth=function(){return b};this.persist=function(){return{chartType:a,color:c,interval:f,lineType:e}};this.setIntervalByHours=function(a){f=a}}TimeseriesStyle.createDefault=function(a){var b=Settings.commonLineWidth;a=Color.stringToColor(a);return new TimeseriesStyle("line",b,a,"byHour","solid")};
var Settings={providerBlackList:[{serviceID:"srv_6d9ccea8d609ecb74d4a512922bb7cee",apiUrl:"http://sensorweb.demo.52north.org/sensorwebclient-webapp-stable/api/v1/"},{serviceID:"srv_7cabc8c30a85fab035c95882df6db343",apiUrl:"http://sensorweb.demo.52north.org/sensorwebclient-webapp-stable/api/v1/"},{serviceID:"srv_7cabc8c30a85fab035c95882df6db343",apiUrl:"http://sensorweb.demo.52north.org/sensorwebclient-webapp-stable/api/v1/"}],restApiUrls:{"http://sensorweb.demo.52north.org/sensorwebclient-webapp-stable/api/v1/":"52nSensorweb",
"http://sosrest.irceline.be/api/v1/":"irceline","http://www.fluggs.de/sos2/api/v1/":"fluggs","http://sensors.geonovum.nl/sos/api/v1/":"geonovum"},defaultProvider:{serviceID:"srv_738111ed219f738cfc85be0c8d87843c",apiUrl:"http://sensorweb.demo.52north.org/sensorwebclient-webapp-stable/api/v1/"},clusterStations:!0,generalizeData:!1,saveStatus:!1,concentrationMarker:!1,zoom:13,dateformat:"DD.MM.YY HH:mmZ",shortDateformat:"DD.MM.YY",ignoreAfterDuration:moment.duration(1,"y"),timeseriesDataBuffer:moment.duration(2,
"h"),defaultMarkerColor:"#123456",defaultZeroScale:!1,defaultGroupedAxis:!0,additionalParameters:{locale:"de"},defaultLanguage:"en",saveStatusPossible:!0,pagesize:20,selectedLineWidth:5,commonLineWidth:2,chartOptions:{},colorList:"#1abc9c #27ae60 #2980b9 #8e44ad #2c3e50 #f1c40f #d35400 #c0392b #7f8c8d".split(" "),intervalList:[{label:_("styleChange.barChartInterval.hour"),value:1},{label:_("styleChange.barChartInterval.day"),value:24},{label:_("styleChange.barChartInterval.week"),value:168},{label:_("styleChange.barChartInterval.month"),
value:720}],timeRangeData:{presets:[{name:"lastHour",label:_("timeSelection.presets.lastHour"),interval:{from:moment().subtract("hours",1),till:moment(),mode:"minutes"}},{name:"today",label:_("timeSelection.presets.today"),interval:{from:moment().startOf("day"),till:moment().endOf("day"),mode:"day"}},{name:"yesterday",label:_("timeSelection.presets.yesterday"),interval:{from:moment().subtract("days",1).startOf("day"),till:moment().subtract("days",1).endOf("day"),mode:"day"}},{name:"todayYesterday",
label:_("timeSelection.presets.todayYesterday"),interval:{from:moment().subtract("days",1).startOf("day"),mode:"day"}},{name:"thisWeek",label:_("timeSelection.presets.thisWeek"),interval:{from:moment().startOf("week"),mode:"week"}},{name:"lastWeek",label:_("timeSelection.presets.lastWeek"),interval:{from:moment().subtract("weeks",1).startOf("week"),till:moment().subtract("weeks",1).endOf("week"),mode:"week"}},{name:"thisMonth",label:_("timeSelection.presets.thisMonth"),interval:{from:moment().startOf("month"),
mode:"month"}},{name:"lastMonth",label:_("timeSelection.presets.lastMonth"),interval:{from:moment().subtract("months",1).startOf("month"),till:moment().subtract("months",1).endOf("month"),mode:"month"}},{name:"thisYear",label:_("timeSelection.presets.thisYear"),interval:{from:moment().startOf("year"),mode:"year"}},{name:"lastYear",label:_("timeSelection.presets.lastYear"),interval:{from:moment().subtract("years",1).startOf("year"),till:moment().subtract("years",1).endOf("year"),mode:"year"}}]},wmsLayer:[],
tileLayerUrl:"http://{s}.tile.osm.org/{z}/{x}/{y}.png",tileLayerOptions:{attribution:'\x26copy; \x3ca href\x3d"http://osm.org/copyright"\x3eOpenStreetMap\x3c/a\x3e contributors'},enableGeoSearch:!0},Template={getTemplate:function(a){var b="";$.ajax({url:"templates/"+a+".html",success:function(a){b=a},dataType:"text",async:!1});return b},createHtml:function(a,b){var c=Template.getTemplate(a);return Mustache.to_html(c,b)}},Storage={generateKey:function(a){var b=window.location;b.origin||(b.origin=b.protocol+
"//"+b.hostname+(b.port?":"+b.port:""));return b.origin+b.pathname+a},saveObject:function(a,b){if(Settings.saveStatusPossible)try{$.totalStorage(a,b)}catch(c){Settings.saveStatusPossible=!1}},load:function(a){return $.totalStorage(a)}},Inform={error:function(a){Inform._createMessage(_("inform.error"),a)},warn:function(a){Inform._createMessage(_("inform.warn"),a)},_createMessage:function(a,b){alert(a+"\n"+b)}},Time={isoTimespan:function(a){var b=a&&a.from||moment().startOf("day"),c=a&&a.till||moment().endOf("day");
return{from:b,till:c,mode:a&&a.mode||"day"}},getRequestTimespan:function(a,b){return moment(a).format()+"/"+moment(b).format()},createTimespan:function(a){var b=a.split("/");if(2===b.length){var c=moment(b[0]),b=moment(b[1]);if(c.isValid()&&b.isValid())return{from:c,till:b,mode:"day"}}return this.isoTimespan(a)},getFormatedTime:function(a){return moment(a).format(Settings.dateformat)}},Color=function(){return{stringToColor:function(a){return a?"#"+this.intToColorHex(this.hashCode(a)):"#000000"},hashCode:function(a){for(var b=
0,c=0;c<a.length;c++)b=a.charCodeAt(c)+((b<<5)-b);return b},intToColorHex:function(a){a=(a>>16&255).toString(16)+(a>>8&255).toString(16)+(a&255).toString(16);for(a=a.toString();6>a.length;)a="0"+a;return a}}}(),Rest={request:function(a,b,c,d){var e=$.Deferred();Settings.additionalParameters&&(b||(b={}),$.each(Settings.additionalParameters,function(a,c){b[a]=c}));$.ajax({url:a,data:b,type:"GET",dataType:"json",success:function(a){c(e,a)},error:function(a){Rest.requestFailed(a);d&&d(e,a)}});return e},
requestFailed:function(a){a.responseJSON&&a.responseJSON.userMessage&&Inform.error(a.responseJSON.userMessage)},tsData:function(a,b,c,d,e){c={timespan:c,generalize:Status.get("generalizeData"),expanded:!0,format:"flot"};e&&(c=$.extend(c,e));return this.request(b+"timeseries/"+a+"/getData",c,function(b,c){var d=tsHelper.createDataOfResult(c,a),e=tsHelper.createRefDataOfResult(c,a);b.resolve(d,e)},function(a,b){a.reject(d)})},stations:function(a,b,c){return Rest.request(b+"stations/"+this._createIdString(a),
c,function(a,b){a.resolve(b)})},features:function(a,b,c){return Rest.request(b+"features/"+Rest._createIdString(a),c,function(a,b){a.resolve(b)})},timeseries:function(a,b,c){$.isEmptyObject(c)&&(c={});c.expanded=!0;c.rendering_hints=!0;return Rest.request(b+"timeseries/"+this._createIdString(a),c,function(a,c){if($.isArray(c)){var f=$.map(c,function(a){return new TimeSeries(a.id,a,b)});a.resolve(f)}else a.resolve(new TimeSeries(c.id,c,b))})},categories:function(a,b,c){return Rest.request(b+"categories/"+
Rest._createIdString(a),c,function(a,b){a.resolve(b)})},phenomena:function(a,b,c){return Rest.request(b+"phenomena/"+Rest._createIdString(a),c,function(a,b){a.resolve(b)})},procedures:function(a,b,c){return Rest.request(b+"procedures/"+Rest._createIdString(a),c,function(a,b){a.resolve(b)})},services:function(a){return Rest.request(a+"services",{expanded:!0},function(a,c){a.resolve(c)})},search:function(a,b){return Rest.request(a+"search",{q:b},function(a,b){a.resolve(b)})},abortRequest:function(a){a&&
"pending"===a.state()&&a.reject()},_createIdString:function(a){return null===a?"":a}},Pages={navigateToPage:function(a){$(".swc-page-current").removeClass("swc-page-current");$(a).addClass("swc-page-current")},navigateToMap:function(){Pages.navigateToPage("#map-page");location.href="#map";Pages.toggleLegend(!1)},navigateToChart:function(){Pages.navigateToPage("#chart-page");location.href="#chart";Pages.togglePhenomenon(!1)},toggleLegend:function(a){a?($(".legend").toggleClass("active"),$(".legend").hasClass("active")?
$('[data-toggle\x3d"legend"]').text("X"):$('[data-toggle\x3d"legend"]').text(_("main.legend"))):($(".legend").removeClass("active"),$('[data-toggle\x3d"legend"]').text(_("main.legend")))},togglePhenomenon:function(a,b){var c=b?b:_("main.phenomena");a?($(".phenomena").toggleClass("active"),$(".phenomena").hasClass("active")?$('[data-toggle\x3d"phenomena"]').text("X"):$('[data-toggle\x3d"phenomena"]').text(c)):($(".phenomena").removeClass("active"),$('[data-toggle\x3d"phenomena"]').text(c))},activateNavButtonsHandler:function(){$('[data-target\x3d"#map"]').click(function(){Pages.navigateToMap()});
$('[data-target\x3d"#chart"]').click(function(){Pages.navigateToChart()})},activateToggleButtonsHandler:function(){$("[data-toggle\x3dlegend]").click(function(){Pages.toggleLegend(!0)});$("[data-toggle\x3dphenomena]").click(function(){var a=$(".phenomena-entry").find(".selected").text();Pages.togglePhenomenon(!0,a)})},init:function(){$(document).ready($.proxy(function(){this.activateNavButtonsHandler();this.activateToggleButtonsHandler()},this));Pages.routeToPage()},routeToPage:function(){var a=window.location.hash;
-1!=a.indexOf("?")&&(a=a.substring(a.indexOf("#"),a.indexOf("?")));Pages._routeToPage(a)},_routeToPage:function(a){switch(a){case "#map":Pages.navigateToPage("#map-page");break;case "#chart":Pages.navigateToPage("#chart-page");break;default:Status.hasTimeseries()?$(".swc-main div.swc-page:first").addClass("swc-page-current"):Pages.navigateToMap()}}},Modal={show:function(a,b){$("#modalWindow").html(Template.createHtml(a,b));$("#modalWindow").modal("show")},hide:function(){$("#modalWindow").modal("hide")},
append:function(a,b){$(".modal-body").append(Template.createHtml(a,b))}},EventManager={subscribe:function(a,b){DEBUG&&console.log("Subscribe "+a);$(this).bind(a,b)},unsubscribe:function(a,b){DEBUG&&console.log("Unsubscribe "+a);$(this).unbind(a,b)},publish:function(a,b){DEBUG&&console.log("Publish "+a);$(this).trigger(a,b)}},Status=function(){return{createDefaultValues:function(){this.defaultValues={provider:Settings.defaultProvider,clusterStations:Settings.clusterStations,generalizeData:Settings.generalizeData,
timeseries:{},timespan:Time.isoTimespan(),saveStatus:Settings.saveStatus,concentrationMarker:Settings.concentrationMarker}},init:function(){this.createDefaultValues();this.key=Storage.generateKey("settings");this.load();this.get("saveStatus")||this.reset()},load:function(){var a=Storage.load(this.key);a?this.current=a:(this.current=this.defaultValues,this.save())},save:function(){Storage.saveObject(this.key,this.current)},reset:function(){this.current=this.defaultValues;this.save();EventManager.publish("resetStatus")},
set:function(a,b){this.current[a]=b;this.save()},get:function(a){return this.current[a]?this.current[a]:this.defaultValues[a]},addTimeseries:function(a){this.current.timeseries[a.getInternalId()]=a.persist();this.save()},addTimeseriesById:function(a){var b=a.split("__"),c=null;$.each(Settings.restApiUrls,function(a,e){e==b[1]&&(c=a)});c&&(this.current.timeseries[a]={apiUrl:c,tsId:b[0]},this.save())},clearTimeseries:function(){this.current.timeseries={};this.save()},removeTimeseries:function(a){delete this.current.timeseries[a.getInternalId()];
this.save()},hasTimeseriesWithId:function(a){return!!this.current.timeseries[a]},getTimeseriesWithId:function(a){return this.current.timeseries[a]},getTimeseries:function(){return this.current.timeseries},hasTimeseries:function(){return $.isEmptyObject(this.current.timeseries)?!1:!0}}}(),Button={switchToggleButton:function(a){a=$(a);a.toggleClass("btn-primary");return a.hasClass("btn-primary")?!0:!1},setToggleButton:function(a,b){var c=$(a);b?c.addClass("btn-primary"):c.removeClass("btn-primary")},
setLoadingButton:function(a,b){var c=a.find("span");b?(c.hide(),a.append('\x3cspan class\x3d"glyphicon glyphicon-refresh icon-spin"\x3e\x3c/span\x3e')):(c.show(),a.find(".glyphicon.glyphicon-refresh").remove())},setNewIcon:function(a,b){a.find("span").hide();a.append('\x3cspan class\x3d"glyphicon '+b+'"\x3e\x3c/span\x3e')},removeNewIcon:function(a,b){a.find("span."+b).remove();a.find("span").show()}};
if(navigator.userAgent.match(/IEMobile\/10\.0/)){var msViewportStyle=document.createElement("style");msViewportStyle.appendChild(document.createTextNode("@-ms-viewport{width:auto!important}"));document.querySelector("head").appendChild(msViewportStyle)}
var tsHelper={createInternalId:function(a,b){return a+"__"+Settings.restApiUrls[b]},createDataOfResult:function(a,b){if(a[b]&&a[b].values)return this._createValues(a[b].values);var c=[];if(a instanceof Array){var d=this;$.each(a,function(a,f){f.name==b&&(c=d._createValues(f.data))})}return c},createRefDataOfResult:function(a,b){var c={},d=this;a[b]&&a[b].extra&&a[b].extra.referenceValues&&$.each(a[b].extra.referenceValues,function(a,b){c[a]=d._createValues(b.values)});a[b]&&a[b].referenceValues&&
$.each(a[b].referenceValues,function(a,b){c[a]=d._createValues(b)});a instanceof Array&&$.each(a,function(a,b){0==b.name.indexOf("ref_")&&(c[b.name]=d._createValues(b.data))});return c},_createValues:function(a){var b=[];if(a[0]instanceof Array)return a;$.each(a,function(a,d){b.push([d.timestamp,d.value])});return b}},StartController={init:function(a){jQuery.support.cors=!0;this.loadMainPage();$.extend(Settings,a);NotifyController.init();Status.init();PermalinkController.init();Pages.init();Map.init();
ListSelectionController.init();LegendController.init();TableController.init();TimeController.init();ChartController.init();TimeSeriesController.init();GuidedTourController.init();ExportController.init();StyleChangeController.init();FavoriteController.init();SettingsController.init()},loadMainPage:function(){var a=Template.createHtml("main");$(".jsc-main").append(a)}},PermalinkController={timespanParam:"span",timeseriesParam:"ts",servicesParam:"services",featuresParam:"features",offeringsParam:"offerings",
proceduresParam:"procedures",phenomenaParam:"phenomena",init:function(){this.checkTimespan();this.checkTimeseries();this.checkConstellation()},evaluateParameter:function(a,b){var c=this.getParameter(a);$.isEmptyObject(c)||b(c)},getParameter:function(a){return Permalink.getUrlParameter(a)},checkTimespan:function(){var a=function(a){Status.set("timespan",Time.createTimespan(a))};this.evaluateParameter("timespan",a);this.evaluateParameter(this.timespanParam,a)},checkTimeseries:function(){var a=function(a){Status.clearTimeseries();
$.each(a.split(","),function(a,b){Status.addTimeseriesById(b)})};this.evaluateParameter("timeseries",a);this.evaluateParameter(this.timeseriesParam,a)},checkConstellation:function(){var a=this.createConstellationParameterArray();if(0<a.length){Pages.navigateToChart();Status.clearTimeseries();var b=0,c,d;$.each(Settings.restApiUrls,function(e,f){$.each(a,function(a,f){b++;Rest.search(e,f.join(",")).done($.proxy(function(a){0<a.length&&(a=$.grep(a,function(a,b){return"timeseries"===a.type?!0:!1}),$.isEmptyObject(a[0])||
(c=a[0].id,d=e,TimeSeriesController.addTSbyId(c,d)));b--;0===b&&$.isEmptyObject(c)&&Inform.warn(_("permalink.noMatchingTimeseriesFound"))},this))})})}},createConstellationParameterArray:function(){var a=[],b=this.getParameterArray(this.servicesParam),c=this.getParameterArray(this.featuresParam),d=this.getParameterArray(this.offeringsParam),e=this.getParameterArray(this.proceduresParam),f=this.getParameterArray(this.phenomenaParam);if(b&&c&&d&&e&&f)if(b.length==c.length&&b.length==d.length&&b.length==
e.length&&b.length==f.length)for(i=0;i<b.length;i++){var g=[];g.push(b[i]);g.push(c[i]);g.push(d[i]);g.push(e[i]);g.push(f[i]);a.push(g)}else Inform.warn(_("permalink.wrongCombinationSize"));return a},getParameterArray:function(a){a=this.getParameter(a);if(!$.isEmptyObject(a))return a.split(",")},createTimespanParam:function(){var a=TimeController.currentTimespan;return this.timespanParam+"\x3d"+Time.getRequestTimespan(a.from,a.till)},createTimeseriesParam:function(){var a=$.map(TimeSeriesController.getTimeseriesCollection(),
function(a,c){return c});return 0<a.length?(a=a.join(","),this.timeseriesParam+"\x3d"+a):""},createPermalink:function(){var a=window.location;a.origin||(a.origin=a.protocol+"//"+a.hostname+(a.port?":"+a.port:""));a=a.origin+a.pathname+"?";a+=this.createTimeseriesParam();return a=a+"\x26"+this.createTimespanParam()}},SettingsController={init:function(){$(document).ready(function(){$('[data-target\x3d"#settings"]').click(function(){Modal.show("settings");Settings.saveStatusPossible?($(".resetStatus").on("click",
function(){Status.reset()}),Button.setToggleButton(".saveStatus",Status.get("saveStatus")),$(".saveStatus").on("click",function(a){a=Button.switchToggleButton(a.currentTarget);Status.set("saveStatus",a)})):($(".resetStatus").remove(),$(".saveStatus").remove());Button.setToggleButton(".clusteringStations",Status.get("clusterStations"));$(".clusteringStations").on("click",function(a){a=Button.switchToggleButton(a.currentTarget);Status.set("clusterStations",a);EventManager.publish("clusterStations",
a)});Button.setToggleButton(".generalizeData",Status.get("generalizeData"));$(".generalizeData").on("click",function(a){a=Button.switchToggleButton(a.currentTarget);Status.set("generalizeData",a);EventManager.publish("timeseries:update:complete")});Button.setToggleButton(".concentrationMarker",Status.get("concentrationMarker"));$(".concentrationMarker").on("click",function(a){a=Button.switchToggleButton(a.currentTarget);Status.set("concentrationMarker",a)});$(".permalink .link").on("click",function(){window.open(PermalinkController.createPermalink(),
"_blank")}).show();$(".permalink .mail").on("click",function(){window.location.href="mailto:?body\x3d"+encodeURIComponent(PermalinkController.createPermalink())}).show();$(".permalink .clipboard").on("click",function(){window.prompt(_("settings.permalink.clipboardInfo"),PermalinkController.createPermalink())}).show();$(".permalink .qr").on("click",function(){var a=qr.image({value:PermalinkController.createPermalink(),size:5});$(".qr-code").find("img").remove();$(".qr-code").append($(a))}).show();
EventManager.publish("settings:opened")})})}},TimeSeriesController={timeseries:{},init:function(){EventManager.subscribe("resetStatus",$.proxy(this.removeAllTS,this));EventManager.subscribe("timeextent:change",$.proxy(this.changeTimeExtent,this));this.loadSavedTimeseries()},loadSavedTimeseries:function(){$.each(Status.getTimeseries(),$.proxy(function(a,b){var c=this;Rest.timeseries(b.tsId,b.apiUrl).done(function(a){if(b.style){var e=a.getStyle();e.setColor(b.style.color);e.setChartType(b.style.chartType);
e.setIntervalByHours(b.style.interval)}c.addTS(a)})},this))},addTSbyId:function(a,b){var c=this;Rest.timeseries(a,b).done(function(a){c.addTS(a)})},addTS:function(a){Status.addTimeseries(a);EventManager.publish("timeseries:add",[a]);this.timeseries[a.getInternalId()]=a;this.loadTsData(a,{from:TimeController.currentTimespan.from,till:TimeController.currentTimespan.till})},loadTsData:function(a,b){EventManager.publish("timeseries:data:load",[a]);a.fetchData(b,$.proxy(this.finishedGetData,this)).fail($.proxy(function(a){this.removeTS(this.timeseries[a]);
this.checkSyncedStatus()},this))},finishedGetData:function(a){EventManager.publish("timeseries:data:loadfinished",[a]);this.checkSyncedStatus()},checkSyncedStatus:function(){var a=!0;$.each(this.timeseries,function(b,c){c.isSynced()||(a=!1)});a&&EventManager.publish("timeseries:synced",[this.timeseries])},changeTimeExtent:function(a,b){this.unsyncTimeseries();$.each(this.timeseries,$.proxy(function(a,d){this.loadTsData(d,b)},this))},unsyncTimeseries:function(){$.each(this.timeseries,function(a,b){b.unSynced()})},
removeTS:function(a){a.destroy();Status.removeTimeseries(a);delete this.timeseries[a.getInternalId()];EventManager.publish("timeseries:remove",[a])},removeAllTS:function(){this.timeseries={};EventManager.publish("timeseries:removeAll")},getTimeseriesCollection:function(){return this.timeseries},getMaxTimeExtent:function(){var a,b;$.each(this.timeseries,$.proxy(function(c,d){var e=moment(d.getFirstValue().timestamp),f=moment(d.getLastValue().timestamp);if(!a||e.isAfter(a))a=e;if(!b||f.isBefore(b))b=
f}));return{from:a,till:b}}},TimeController={currentTimespan:{},timeRangeData:Settings.timeRangeData,init:function(){this.currentTimespan=Status.get("timespan");this.updateTimeExtent();$(document).ready(function(){$("[data-action\x3dbefore]").click($.proxy(function(){TimeController.prevPeriode()},this));$("[data-action\x3dafter]").click($.proxy(function(){TimeController.nextPeriode()},this));$("[data-action\x3dtimeextent]").click($.proxy(function(){Modal.show("time-range-settings",TimeController.timeRangeData);
var a=moment(TimeController.currentTimespan.from),b=moment(TimeController.currentTimespan.till);$("#startPicker").text(a.format(Settings.dateformat));$("#endPicker").text(b.format(Settings.dateformat));$("#startPicker").data("date",a.format("YYYY-MM-DD"));$("#endPicker").data("date",b.format("YYYY-MM-DD"));$("#alertTimeExtent").hide();$("#startPicker").datepicker({position:"above"}).on("changeDate",TimeController.evaluateDate);$("#endPicker").datepicker({position:"above"}).on("changeDate",TimeController.evaluateDate);
$("#confirmTimeExtent").click(function(a){a=moment($("#startPicker").data("date")).startOf("day");var b=moment($("#endPicker").data("date")).endOf("day");TimeController.currentTimespan={from:a,till:b,mode:"range"};TimeController.updateTimeExtent()});$(".preset-btn").click(function(a){a=$(a.currentTarget);TimeController.setPreset(a.data("preset-value"))})},this))});this.setLabel();EventManager.subscribe("timeseries:data:load",$.proxy(this.disableButtons,this));EventManager.subscribe("timeseries:synced",
$.proxy(this.enableButtons,this));EventManager.subscribe("time:start:change",$.proxy(this.startChanged,this));EventManager.subscribe("time:end:change",$.proxy(this.endChanged,this));EventManager.subscribe("timeseries:update:complete",$.proxy(this.updateTimeExtent,this))},startChanged:function(a,b){var c=this.getCurrentDiff();this.currentTimespan.from=moment(b).startOf("day");this.currentTimespan.till=moment(b).add(c).add("s",1).startOf("day").subtract("ms",1);this.updateTimeExtent()},endChanged:function(a,
b){var c=this.getCurrentDiff();this.currentTimespan.from=moment(b).subtract(c).endOf("day").add("ms",1);this.currentTimespan.till=moment(b).endOf("day");this.updateTimeExtent()},getCurrentDiff:function(){var a=moment(this.currentTimespan.from);return moment(this.currentTimespan.till).diff(a)},getCurrentStartAsMillis:function(){return 1E3*moment(this.currentTimespan.from).unix()},getCurrentEndAsMillis:function(){return 1E3*moment(this.currentTimespan.till).unix()},updateTimeExtent:function(){var a=
TimeSeriesController.getMaxTimeExtent(),b=!0;a.from&&a.till&&(b=moment(a.from),a=moment(a.till),b=this.currentTimespan.till.isBefore(b),a=this.currentTimespan.from.isAfter(a),b=!(b||a));b||(NotifyController.notify(_("chart.outsideOfDataRange")),this.currentTimespan=Status.get("timespan"));EventManager.publish("timeextent:change",{from:this.currentTimespan.from,till:this.currentTimespan.till});Status.set("timespan",this.currentTimespan);this.setLabel()},disableButtons:function(){$('[data-action\x3d"before"]').addClass("disabled");
$('[data-action\x3d"after"]').addClass("disabled");$('[data-action\x3d"timeextent"]').addClass("disabled")},enableButtons:function(){$('[data-action\x3d"before"]').removeClass("disabled");$('[data-action\x3d"after"]').removeClass("disabled");$('[data-action\x3d"timeextent"]').removeClass("disabled")},setLabel:function(){var a=moment(this.currentTimespan.from).format(Settings.shortDateformat)+" - "+moment(this.currentTimespan.till).format(Settings.shortDateformat);$("[data-action\x3dtimeextent]").text(a)},
prevPeriode:function(){this.getNearbyPeriode("subtract");this.updateTimeExtent()},nextPeriode:function(){this.getNearbyPeriode("add");this.updateTimeExtent()},setPreset:function(a){var b;$.each(this.timeRangeData.presets,function(c,d){if(d.name===a)return b=this.interval,!1});this.currentTimespan=Time.isoTimespan(b);this.updateTimeExtent();Modal.hide()},setFlexibleTimeExtent:function(a,b){this.currentTimespan={from:a,till:b,mode:"range"};this.updateTimeExtent()},evaluateDate:function(a){if("days"==
a.viewMode){var b="#"+a.currentTarget.id;moment($("#startPicker").data("date")).isAfter($("#endPicker").data("date"))?($("#alertTimeExtent").show(),$("#confirmTimeExtent").addClass("disabled"),$("#alertTimeExtent").text(_("timeSelection.warning.startBeforeEnd"))):1<Math.abs(moment($("#startPicker").data("date")).diff($("#endPicker").data("date"),"years",!0))?($("#alertTimeExtent").show(),$("#confirmTimeExtent").addClass("disabled"),$("#alertTimeExtent").text(_("timeSelection.warning.maxTimeRange"))):
($("#alertTimeExtent").hide(),$("#confirmTimeExtent").removeClass("disabled"),startDate=new Date(a.date));$(b).text(moment($(b).data("date")).format(Settings.dateformat));$(b).datepicker("hide")}},getNearbyPeriode:function(a){var b=this.currentTimespan.mode,c=moment(this.currentTimespan.from),d=moment(this.currentTimespan.till);switch(b){case "range":var e=d.diff(c),c=c[a](e);a=d[a](e);break;case "day":c=c[a]("days",1).startOf("day");a=d[a]("days",1).endOf("day");break;case "month":c=c[a]("months",
1).startOf("month");a=d[a]("months",1).endOf("month");break;case "week":c=c[a]("weeks",1).startOf("week");a=d[a]("weeks",1).endOf("week");break;case "year":c=c[a]("years",1).startOf("year");a=d[a]("years",1).endOf("year");break;default:a=d}this.currentTimespan={from:c,till:a,mode:b}}},Map={defaultTileLayerUrl:"http://{s}.tile.osm.org/{z}/{x}/{y}.png",defaultTileLayerOptions:{attribution:'\x26copy; \x3ca href\x3d"http://osm.org/copyright"\x3eOpenStreetMap\x3c/a\x3e contributors'},timeseriesCache:[],
init:function(){this.tileLayerUrl=Settings.tileLayerUrl||this.defaultTileLayerUrl;this.tileLayerOptions=Settings.tileLayerOptions||this.defaultTileLayerOptions;$(document).ready(function(){$('[data-action\x3d"provider"]').click(function(){Map.openProviderList()});$('[data-action\x3d"locate"]').click(function(){Map.locateUser()})});this.createMap();this.loadStations();EventManager.subscribe("resetStatus",$.proxy(this.loadStations,this));EventManager.subscribe("clusterStations",$.proxy(this.loadStations,
this));EventManager.subscribe("timeseries:showInMap",$.proxy(this.showTsInMap,this))},createMap:function(){if(0<$("#map").length){this.map=L.map("map");L.tileLayer(this.tileLayerUrl,this.tileLayerOptions).addTo(this.map);var a={};$.each(Settings.wmsLayer,$.proxy(function(b,c){try{var d=L.tileLayer.wms(c.url,c.options).addTo(this.map);a[c.name]=d}catch(e){console.error("Could not add wms.")}},this));$.isEmptyObject(a)||L.control.layers(null,a,{position:"topleft"}).addTo(this.map);L.Icon.Default.imagePath=
"images";this.map.whenReady(function(a){this.map.on("locationfound",this.onLocationFound);this.map.on("locationerror",this.onLocationError)},this);L.control.scale().addTo(this.map);Settings.enableGeoSearch&&(new L.Control.GeoSearch({url:"http://nominatim.openstreetmap.org/search?format\x3djson\x26q\x3d{s}",jsonpParam:"json_callback",propertyName:"display_name",searchLabel:_("map.search.label"),notFoundMessage:_("map.search.noResult"),propertyLoc:["lat","lon"],position:"topcenter",minLength:2,showMarker:!1,
provider:new L.GeoSearch.Provider.OpenStreetMap,zoomLevel:13})).addTo(this.map);this.map.fitBounds([[-80,-170],[80,170]])}},loadStations:function(){this.loading(!0);var a=Status.get("provider");Rest.stations(null,a.apiUrl,{service:a.serviceID}).done($.proxy(function(a){this.createStationMarker(a,Status.get("clusterStations"));this.loading(!1)},this));Rest.phenomena(null,a.apiUrl,{service:a.serviceID}).done($.proxy(this.fillPhenomenaList,this))},createStationMarker:function(a,b){this.map||this.createMap();
this.stationMarkers&&this.map.removeLayer(this.stationMarkers);if(0<a.length){var c=a[0].geometry.coordinates,d=c[1],e=c[1],f=c[0],g=c[0];this.stationMarkers=b?new L.MarkerClusterGroup:new L.LayerGroup;that=this;$.each(a,$.proxy(function(a,b){var c=b.geometry.coordinates;isNaN(c[0])&&isNaN(c[1])||(c[0]>g&&(g=c[0]),c[0]<f&&(f=c[0]),c[1]>d&&(d=c[1]),c[1]<e&&(e=c[1]),c=new L.Marker([c[1],c[0]],{id:b.properties.id}),c.on("click",$.proxy(that.markerClicked,that)),this.stationMarkers.addLayer(c))},this));
this.map.addLayer(this.stationMarkers);this.map.fitBounds([[parseFloat(e),parseFloat(f)],[parseFloat(d),parseFloat(g)]])}},createColoredMarkers:function(a){this.stationMarkers&&this.map.removeLayer(this.stationMarkers);if(0<a.length){var b=a[0].getCoordinates(),c=b[1],d=b[1],e=b[0],f=b[0];this.stationMarkers=new L.LayerGroup;that=this;$.each(a,$.proxy(function(a,b){var h=b.getCoordinates();if(!isNaN(h[0])||!isNaN(h[1])){h[0]>f&&(f=h[0]);h[0]<e&&(e=h[0]);h[1]>c&&(c=h[1]);h[1]<d&&(d=h[1]);if(b.isCurrent())var k=
this.getMatchingInterval(b),k=k&&k.color?k.color:Settings.defaultMarkerColor,h=new L.circleMarker([h[1],h[0]],{id:b.getStationId(),fillColor:k,color:"#000",opacity:1,weight:2,fillOpacity:0.8});else h=new L.Marker([h[1],h[0]],{id:b.getStationId()});h.on("click",$.proxy(that.markerClicked,that));this.stationMarkers.addLayer(h)}},this));this.map.addLayer(this.stationMarkers);this.map.fitBounds([[parseFloat(d),parseFloat(e)],[parseFloat(c),parseFloat(f)]])}},getMatchingInterval:function(a){var b=null;
if(a.getLastValue()&&a.getStatusIntervals()){var c=a.getLastValue().value;$.each(a.getStatusIntervals(),function(a,e){null==e.upper&&(e.upper=Number.MAX_VALUE);null==e.lower&&(e.lower=Number.MIN_VALUE);if(!isNaN(e.upper)&&!isNaN(e.lower)&&parseFloat(e.lower)<c&&c<parseFloat(e.upper))return b=e,!1})}return b},loading:function(a){Button.setLoadingButton($('[data-action\x3d"provider"]'),a)},markerClicked:function(a){this.loading(!0);var b=Status.get("provider").apiUrl;this.openStationWindow(a.target.options.id,
b)},openStationWindow:function(a,b){Rest.stations(a,b).done($.proxy(function(a){var d={};$.each(a.properties.timeseries,function(a,c){var g=c.phenomenon.id;if(null==Map.selectedPhenomenon||Map.selectedPhenomenon==g)d.hasOwnProperty(g)||(d[g]={},d[g].timeseries=[],d[g].label=c.phenomenon.label,d[g].category=c.category&&c.category.label?c.category.label:""),d[g].timeseries.push({id:a,internalId:tsHelper.createInternalId(a,b),selected:Status.hasTimeseriesWithId(a),procedure:c.procedure.label,category:c.category&&
c.category.label?c.category.label:""})});this.loading(!1);Modal.show("station",{name:a.properties.label,phenomena:$.map(d,function(a){return a})});$("#confirmTimeseriesSelection").on("click",function(){$.each($(".tsItem").has(":checked"),function(a,b){Map.addTimeseries(Map.timeseriesCache[$(this).data("internalid")])})});1<$(".tsItem").length?($(".selectAllOption").show(),$(".selectAllOption .checkbox").on("click",function(a){var b=$(a.currentTarget).find(":checkbox").is(":checked");$.each($(".tsItem"),
function(a,c){$(c).find(":checkbox").prop("checked",b)})})):$(".tsItem").find(":checkbox").prop("checked",!0);$.each(d,function(a,c){$.each(c.timeseries,function(a,c){null==Map.timeseriesCache[c.internalId]?Rest.timeseries(c.id,b).done(function(a){Map.updateTsEntry(a)}):Map.updateTsEntry(Map.timeseriesCache[c.internalId])})});EventManager.publish("map:stationLoaded")},this))},updateTsEntry:function(a){$("[data-id\x3d"+a.getTsId()+"]").addClass("loaded").find(":input").prop("disabled",!1);var b=a.getLastValueFormatted();
b&&$("[data-id\x3d"+a.getTsId()+"]").find(".additionalInfo").text(b).show();Map.timeseriesCache[a.getInternalId()]=a},addTimeseries:function(a){Pages.navigateToChart();Modal.hide();TimeSeriesController.addTS(a)},fillPhenomenaList:function(a){Pages.togglePhenomenon(!1);$(".phenomena-entry").empty();this.createDefaultPhenomenaEntry();$.each(a,$.proxy(function(a,c){var d=this.createPhenomenaEntry(c);$(".phenomena-entry").append(d);$("[data-id\x3d"+c.id+"]").click($.proxy(function(a){$(".phenomena-entry").find(".selected").removeClass("selected");
$("[data-id\x3d"+c.id+"]").find(".item").addClass("selected").addClass("loadPhen");this.selectedPhenomenon=c.id;a=Status.get("concentrationMarker");var b=Status.get("provider");Rest.abortRequest(this.phenomenonPromise);this.phenomenonPromise=a?Rest.timeseries(null,b.apiUrl,{service:b.serviceID,phenomenon:c.id,expanded:!0,force_latest_values:!0,status_intervals:!0}).done($.proxy(function(a){$.each(a,function(a,b){Map.timeseriesCache[b.getInternalId()]=b});Pages.togglePhenomenon(!1,c.label);this.createColoredMarkers(a)},
this)).always($.proxy(function(){$("[data-id\x3d"+c.id+"]").find(".item").removeClass("loadPhen")})):Rest.stations(null,b.apiUrl,{service:b.serviceID,phenomenon:c.id}).done($.proxy(function(a){Pages.togglePhenomenon(!1,c.label);this.createStationMarker(a,!1)},this)).always($.proxy(function(){$("[data-id\x3d"+c.id+"]").find(".item").removeClass("loadPhen")}))},this))},this))},createPhenomenaEntry:function(a){this.selectedPhenomenon=null;return Template.createHtml("phenomenon-entry",{id:a.id,label:a.label})},
createDefaultPhenomenaEntry:function(){$(".phenomena-entry").append(this.createPhenomenaEntry({id:"all",label:_("main.phenomena")}));$("[data-id\x3dall]").click($.proxy(function(a,b){$(".phenomena-entry").find(".selected").removeClass("selected");$("[data-id\x3dall]").find(".item").addClass("selected");Pages.togglePhenomenon(!1);Map.loadStations()}));$("[data-id\x3dall]").find(".item").addClass("selected")},openProviderList:function(){this.loading(!0);this.apiConnectCounter=Object.keys(Settings.restApiUrls).length;
this.providerList=[];$.each(Settings.restApiUrls,$.proxy(function(a,b){Rest.services(a).done($.proxy(this.createProviderList,this,a))},this))},createProviderList:function(a,b){this.apiConnectCounter--;var c=Status.get("provider");$.each(b,$.proxy(function(b,d){var g=!1;$.each(Settings.providerBlackList,$.proxy(function(b,c){c.serviceID==d.id&&c.apiUrl==a&&(g=!0)},this));g||this.providerList.push({name:d.label,version:d.version,stations:d.quantities.stations,timeseries:d.quantities.timeseries,phenomena:d.quantities.phenomena,
url:d.serviceUrl,apiUrl:a,id:d.id,selected:c.serviceID==d.id&&c.apiUrl==a,type:d.type})},this));if(0===this.apiConnectCounter){var d={providers:this.providerList};this.loading(!1);Modal.show("providers",d);$(".providerItem").on("click",function(){var a=$(this).data("id"),b=$(this).data("api");Status.set("provider",{serviceID:a,apiUrl:b});Map.loadStations();Modal.hide()})}},locateUser:function(){Button.setLoadingButton($('[data-action\x3d"locate"]'),!0);this.map.locate({setView:!0,maxZoom:Settings.zoom})},
onLocationFound:function(a){Button.setLoadingButton($('[data-action\x3d"locate"]'),!1);a=L.popup().setLatLng(a.latlng).setContent("\x3cp\x3e"+_("map.userLocation")+"\x3c/p\x3e");Map.map.openPopup(a)},onLocationError:function(a){Button.setLoadingButton($('[data-action\x3d"locate"]'),!1);Inform.error(a.message)},showTsInMap:function(a,b){Pages.navigateToMap();var c=b.getCoordinates(),c=L.latLng(c[1],c[0]);Map.map.setView(c,Settings.zoom);var d=null;$.each(this.stationMarkers.getLayers(),function(a,
c){c.options.id==b.getStationId()&&(d=c)});var e=L.popup({autoPan:!1});e.setContent(Template.createHtml("station-popup",{station:b.getStationLabel(),timeseries:b.getLabel(),service:b.getServiceLabel()}));d?setTimeout(function(){d.bindPopup(e).openPopup()},1E3):(e.setLatLng(c),e.openOn(Map.map));e.on("close",function(){d&&d.unbindPopup()})}},ListSelectionController={category:{type:"category",heading:_("listSelection.headers.category"),call:Rest.categories},station:{type:"feature",heading:_("listSelection.headers.station"),
call:Rest.features},phenomenon:{type:"phenomenon",heading:_("listSelection.headers.phenomenon"),call:Rest.phenomena},procedure:{type:"procedure",heading:_("listSelection.headers.procedure"),call:Rest.procedures},init:function(){this.entries={category:[this.category,this.station,this.phenomenon,this.procedure],sensor:[this.procedure,this.station,this.category,this.phenomenon],station:[this.station,this.category,this.phenomenon,this.procedure],phenomenon:[this.phenomenon,this.category,this.station,
this.procedure]};$('[data-action\x3d"listSelection"]').show();$('[data-action\x3d"listSelection"]').click(function(){ListSelectionController.open()})},open:function(){Modal.show("list-selection");$('a[data-toggle\x3d"tab"]').on("shown.bs.tab",$.proxy(function(a){var b=$(a.target).data("tab"),c=$("#"+b+" .panel-group")[0].id;$("#"+b+" .panel-group").empty();this.startRequest(b,0,{service:Status.get("provider").serviceID});$.each(this.entries[b],function(a,e){e.accordion=c;e.collapse=c+e.type;$("#"+
b+" .panel-group").append(Template.createHtml("list-selection-skeleton",e))})},this));$("#selectionList a:first").tab("show")},startRequest:function(a,b,c){var d=this.entries[a][b],e=Status.get("provider").apiUrl;d?d.call(null,e,c).done($.proxy(function(e){$("#"+a+" #"+d.collapse+" .panel-body").empty();$.each(e,function(b,c){var e=c.id?c:c.properties,e=Template.createHtml("list-selection-entry",{id:e.id,label:e.label});$("#"+a+" #"+d.collapse+" .panel-body").append(e)});$("#"+a+" .collapse.in").collapse("hide");
$("#"+a+" #"+d.collapse+".collapse").collapse("show");$("#"+a+" #"+d.collapse+" .panel-body div").on("click",$.proxy(function(e){var f=$.trim(e.target.innerHTML);$("#"+a+" [href\x3d#"+d.collapse+"]").text(d.heading+" - "+f);$("#"+a+" #"+d.collapse).collapse("hide");c[d.type]=e.target.dataset.id;this.startRequest(a,b+1,c)},this))},this)):Rest.timeseries(null,e,c).done(function(a){1==a.length?(TimeSeriesController.addTS(a[0]),Modal.hide(),Pages.navigateToChart()):Inform.warn(_("listSelection.warning.moreThanOneTimeseries"))})}},
ChartController={defaultOptions:{series:{lines:{show:!0,fill:!1},shadowSize:1},selection:{mode:"xy"},xaxis:{mode:"time",timezone:"browser"},yaxis:{show:!0,additionalWidth:17,panRange:!1},legend:{},pan:{interactive:!0,frameRate:10}},visible:!0,data:[],init:function(){this.selectedLineWidth=Settings.selectedLineWidth;this.commonLineWidth=Settings.commonLineWidth;this.options=$.extend(this.defaultOptions,Settings.chartOptions);EventManager.subscribe("timeseries:data:load",$.proxy(this.loadDataForChart,
this));EventManager.subscribe("timeseries:data:loadfinished",$.proxy(this.loadDataFinished,this));EventManager.subscribe("timeseries:synced",$.proxy(this.plotChart,this));EventManager.subscribe("timeseries:add:referenceValue",$.proxy(this.showReferenceValue,this));EventManager.subscribe("timeseries:remove:referenceValue",$.proxy(this.removeReferenceValue,this));EventManager.subscribe("timeseries:remove",$.proxy(this.removeTS,this));EventManager.subscribe("timeseries:removeAll",$.proxy(this.clearChart,
this));EventManager.subscribe("timeseries:selected",$.proxy(this.selectTs,this));EventManager.subscribe("timeseries:unselectAll",$.proxy(this.unselectAll,this));EventManager.subscribe("timeseries:hide",$.proxy(this.hideData,this));EventManager.subscribe("timeseries:show",$.proxy(this.showData,this));EventManager.subscribe("navigation:open",$.proxy(this.hideChart,this));EventManager.subscribe("navigation:close",$.proxy(this.showChart,this));EventManager.subscribe("timeseries:changeStyle",$.proxy(this.changeStyle,
this));EventManager.subscribe("timeseries:zeroScaled",$.proxy(this.zeroScaled,this));EventManager.subscribe("timeseries:groupedAxis",$.proxy(this.changeStyle,this));$(window).resize($.proxy(function(){var a=$(document).width()/$(document).height();a!==window.ratio&&(window.ratio=a,this.plotChart())},this));$("[data-action\x3dselection]").hide();$("[data-action\x3dselection]").on("click",$.proxy(function(){EventManager.publish("timeseries:unselectAll");this.renderChart();$("[data-action\x3dselection]").hide()},
this));this.plotChart();$("#placeholder").bind("plotpanEnd",function(a,b){var c=b.getXAxes()[0],d=moment(c.min),c=moment(c.max);TimeController.setFlexibleTimeExtent(d,c)})},hideChart:function(a,b){this.visible=!1;$("#placeholder").hide()},showChart:function(a,b){this.visible=!0;$("#placeholder").show();this.plotChart()},hideData:function(a,b){this.removeData(b);this.plotChart()},showData:function(a,b){var c=TimeSeriesController.getTimeseriesCollection()[b];this.loadDataFinished(null,c);this.plotChart()},
selectTs:function(a,b){this.plot&&($.each(this.plot.getData(),function(a,d){d.id===b&&(d.lines.lineWidth=ChartController.selectedLineWidth,d.bars.lineWidth=ChartController.selectedLineWidth,d.selected=!0,$.each($(".axisTarget"),function(a,b){d.yaxis.n===$(b).data("axis.n")&&$(b).toggleClass("selected")}))}),this.plot.draw(),$.each(this.data,function(a,d){d.id===b&&(d.selected=!0)}))},unselectAll:function(a){this.plot&&($.each(this.plot.getData(),function(a,c){c.lines.lineWidth=ChartController.commonLineWidth;
c.bars.lineWidth=ChartController.commonLineWidth;c.selected=!1}),$.each(this.data,function(a,c){c.selected=!1}),$(".axisTarget").removeClass("selected"),this.plot.draw())},loadDataForChart:function(a,b){if(this.visible){var c=b.getLabel(),c=Template.createHtml("data-loading-entry",{id:b.getInternalId(),color:b.getStyle().getColor(),label:c});$("#loadingDiagram").append(c)}},zeroScaled:function(a,b){$.each(TimeSeriesController.getTimeseriesCollection(),function(a,d){b.getUom()===d.getUom()&&d.setZeroScaled(b.isZeroScaled())});
$.each(this.data,function(a,d){d.uom===b.getUom()&&(d.zeroScaled=b.isZeroScaled())});this.changeStyle(null,b)},changeStyle:function(a,b){this.loadDataFinished(null,b);this.plotChart()},loadDataFinished:function(a,b){$("#loadingDiagram").find("[data-id\x3d"+b.getInternalId()+"]").remove();$.each(b.getRefValues(),$.proxy(function(a,b){var c=this.dataAlreadyIn(b.getId());c&&(c.data=b.getValues())},this));if(b.hasData()){var c=this.dataAlreadyIn(b.getInternalId());c?this.updateData(c,b):this.data.push(this.createData(b))}else this.removeData(b.getInternalId())},
updateData:function(a,b){this.addStyleAndValues(a,b)},createData:function(a){var b={id:a.getInternalId(),uom:a.getUom(),phenomenon:a.getPhenomenonLabel()};this.addStyleAndValues(b,a);return b},addStyleAndValues:function(a,b){var c=b.getStyle();a.color=c.getColor();a.zeroScaled=b.isZeroScaled();a.groupedAxis=b.isGroupedAxis();a.stationLabel=b.getStationLabel();if(c.isBarChart()){a.bars={show:!0,barWidth:36E5*c.getIntervalByHours()};a.lines={show:!1};for(var d=[],e=0,f=b.getValues(),g=f[e];g;){for(var m=
g[0],h=moment(g[0]).add("hours",c.getIntervalByHours()),k=0;g&&moment(g[0]).isBefore(h);)e++,k+=g[1],g=f[e];d.push([m,k])}a.data=d}else 0<=c.getLineType().indexOf("dotted")&&(a.points={show:!0,fill:!0,fillColor:c.getColor(),radius:c.getWidth()}),0<=c.getLineType().indexOf("solid")?a.lines={show:!0,lineWidth:c.getWidth()}:a.lines={show:!1},a.data=b.getValues()},removeTS:function(a,b){$("#loadingDiagram").find("[data-id\x3d"+b.getInternalId()+"]").remove();this.removeData(b.getInternalId());$.each(b.getRefValues(),
$.proxy(function(a,b){this.removeData(b.getId())},this));this.plotChart()},showReferenceValue:function(a,b){var c=TimeSeriesController.getTimeseriesCollection()[b.tsId],d=c.getRefValuesForId(b.refId);this.data.push({data:d.getValues(),id:d.getId(),color:d.getColor(),uom:c.getUom(),lines:{lineWidth:Settings.commonLineWidth}});this.plotChart()},removeReferenceValue:function(a,b){this.removeData(b.refId);this.plotChart()},clearChart:function(){this.data=[];this.plotChart()},plotChart:function(){if(this.visible)if($("#placeholder").show(),
0===this.data.length)$("#placeholder").empty(),$("#placeholder").append(Template.createHtml("chart-empty"));else{this.updateXAxis();this.options.yaxes=this.createYAxis();this.plot=$.plot("#placeholder",this.data,this.options);$.each(this.plot.getAxes(),$.proxy(function(a,c){if(c.show){var d=c.box;if("y"===c.direction){$("\x3cdiv class\x3d'axisTarget' style\x3d'position:absolute; left:"+d.left+"px; top:"+d.top+"px; width:"+d.width+"px; height:"+d.height+"px'\x3e\x3c/div\x3e").data("axis.n",c.n).appendTo(this.plot.getPlaceholder()).click($.proxy(function(a){var b=
$(a.currentTarget),d=!1;$.each($(".axisTarget"),function(a,c){c=$(c);if(b.data("axis.n")===c.data("axis.n"))return d=c.hasClass("selected"),!1});EventManager.publish("timeseries:unselectAll");$.each(this.plot.getData(),function(a,e){if(e.yaxis.n===c.n&&!d&&(EventManager.publish("timeseries:selected",e.id),b.addClass("selected"),!e.groupedAxis))return!1});this.plot.draw()},this));var e=$("\x3cdiv class\x3d'axisLabel yaxisLabel' style\x3dleft:"+d.left+"px;\x3e\x3c/div\x3e").text(c.options.uom).appendTo("#placeholder");
$.each(c.options.tsColors,function(a,b){$("\x3cspan\x3e").html("\x26nbsp;\x26#x25CF;").css("color",b).addClass("labelColorMarker").appendTo(e)});e.css("margin-left",-(e.width()-e.height())/2-3)}}},this));var a=!1;$.each(this.plot.getData(),function(b,c){c.selected&&(c.lines.lineWidth=ChartController.selectedLineWidth,c.bars.lineWidth=ChartController.selectedLineWidth,a=!0,$.each($(".axisTarget"),function(){if($(this).data("axis.n")===c.yaxis.n&&!$(this).hasClass("selected"))return $(this).addClass("selected"),
!1}))});a&&this.plot.draw()}},updateXAxis:function(){this.options.xaxis.min=TimeController.getCurrentStartAsMillis();this.options.xaxis.max=TimeController.getCurrentEndAsMillis()},createYAxis:function(){var a={};$.each(this.data,function(b,d){void 0===d.groupedAxis||d.groupedAxis?(a.hasOwnProperty(d.uom)?a[d.uom].tsColors.push(d.color):a[d.uom]={id:++Object.keys(a).length,uom:d.uom,tsColors:[d.color],zeroScaled:d.zeroScaled},d.yaxis=a[d.uom].id):(a[d.id]={id:++Object.keys(a).length,uom:d.uom+" @ "+
d.stationLabel,tsColors:[d.color],zeroScaled:d.zeroScaled},d.yaxis=a[d.id].id)});var b=[];$.each(a,function(a,d){b.splice(d.id-1,0,{uom:d.uom,tsColors:d.tsColors,min:d.zeroScaled?0:null})});return b},dataAlreadyIn:function(a){var b=null,b=$.map(this.data,function(b){if(a===b.id)return b});return b[0]},removeData:function(a){var b=-1;$.each(this.data,function(c,d){a==d.id&&(b=c)});0<=b&&this.data.splice(b,1)}},LegendController={init:function(){EventManager.subscribe("timeseries:add",$.proxy(this.addTS,
this));EventManager.subscribe("timeseries:remove",$.proxy(this.removeTS,this));EventManager.subscribe("timeseries:removeAll",$.proxy(this.removeAll,this));EventManager.subscribe("timeseries:selected",$.proxy(this.selectTS,this));EventManager.subscribe("timeseries:unselectAll",$.proxy(this.deselectAllTS,this));EventManager.subscribe("timeseries:data:loadfinished",$.proxy(this.checkNoData,this));EventManager.subscribe("timeseries:changeStyle",$.proxy(this.changeStyle,this));EventManager.subscribe("timeseries:synced",
$.proxy(this.syncedTS,this))},addTS:function(a,b){var c=this.createEntry(b);this.removeEntry(b.getInternalId());$(".legend-entry").append(c);this.addClickEvents(b)},addClickEvents:function(a){$("[data-id\x3d"+a.getInternalId()+"] .firstLastEntry").on("click",function(a){a.stopPropagation();var c=$(a.currentTarget).data("firsttime");c&&EventManager.publish("time:start:change",c);(c=$(a.currentTarget).data("lasttime"))&&EventManager.publish("time:end:change",c)});$("[data-id\x3d"+a.getInternalId()+
"] .legendItemheader").click($.proxy(function(b){$("[data-id\x3d"+a.getInternalId()+"]").hasClass("selected")?EventManager.publish("timeseries:unselectAll"):(EventManager.publish("timeseries:unselectAll"),EventManager.publish("timeseries:selected",a.getInternalId()))},this));$("[data-id\x3d"+a.getInternalId()+"] .hideDiagram").click($.proxy(function(b){target=$(b.currentTarget);target.hasClass("glyphicon-eye-close")?EventManager.publish("timeseries:hide",a.getInternalId()):EventManager.publish("timeseries:show",
a.getInternalId());target.toggleClass("glyphicon-eye-close");target.toggleClass("glyphicon-eye-open")},this));$("[data-id\x3d"+a.getInternalId()+"] .delete").click($.proxy(function(b){TimeSeriesController.removeTS(a)},this));$("[data-id\x3d"+a.getInternalId()+"] .inMap").click($.proxy(function(b){EventManager.publish("timeseries:showInMap",a)},this));$("[data-id\x3d"+a.getInternalId()+"] .changeStyle").click($.proxy(function(b){StyleChangeController.open(a)},this));$("[data-id\x3d"+a.getInternalId()+
"] .showInfo").click($.proxy(function(b){$("[data-id\x3d"+a.getInternalId()+"]").find(".collapseLegendEntry").toggle()},this));$("[data-id\x3d"+a.getInternalId()+"] .refEntry").on("click",function(b){b=$(b.currentTarget);b.toggleClass("selected");var c;c=b.hasClass("selected")?"timeseries:add:referenceValue":"timeseries:remove:referenceValue";EventManager.publish(c,{tsId:a.getInternalId(),refId:b.data("refid")})})},checkNoData:function(a,b){var c=$(".legend-entry").find("[data-id\x3d"+b.getInternalId()+
"] .noDataWarning");b.hasData()?c.hide():c.show()},selectTS:function(a,b){$(".legend-entry").find("[data-id\x3d"+b+"]").addClass("selected")},changeStyle:function(a,b){this.updateEntry(b)},deselectAllTS:function(a){$(".legend-entry").find(".legendItem.selected").removeClass("selected")},removeTS:function(a,b){this.removeEntry(b.getInternalId())},removeAll:function(a){$(".legend-entry").empty()},removeEntry:function(a){$(".legend-entry").find("[data-id\x3d"+a+"]").remove()},updateEntry:function(a){var b=
this.createEntry(a);$(b).replaceAll(".legend-entry [data-id\x3d"+a.getInternalId()+"]");this.addClickEvents(a)},syncedTS:function(){var a=!0;$.each(TimeSeriesController.timeseries,function(b,c){c.hasData()&&(a=!1)});a&&Pages.toggleLegend(!0)},createEntry:function(a){var b=a.getFirstValue(),c=a.getLastValue(),d=$.map(a.getRefValues(),function(a,b){return{id:a.getId(),label:a.getLabel(),color:a.getColor()}});return Template.createHtml("legend-entry",{id:a.getInternalId(),color:a.getStyle().getColor(),
synced:a.isSynced(),uom:this.createText(a.getUom),phenomenon:this.createText(a.getPhenomenonLabel()),procedure:this.createText(a.getProcedureLabel()),station:this.createText(a.getStationLabel()),category:this.createText(a.getCategoryLabel()),firstValueTime:b?b.timestamp:"",firstValueTimeFormatted:b?moment(b.timestamp).format(Settings.dateformat):"",firstValue:b?b.value:"",lastValueTime:c?c.timestamp:"",lastValueTimeFormatted:c?moment(c.timestamp).format(Settings.dateformat):"",lastValue:c?c.value:
"",referenceValues:d})},createText:function(a){return a?a:""}},StyleChangeController={defaultColorList:"#1abc9c #27ae60 #2980b9 #8e44ad #2c3e50 #f1c40f #d35400 #c0392b #7f8c8d".split(" "),defaultIntervalList:[{label:_("styleChange.barChartInterval.hour"),value:1},{label:_("styleChange.barChartInterval.day"),value:24},{label:_("styleChange.barChartInterval.week"),value:168},{label:_("styleChange.barChartInterval.month"),value:720}],init:function(){this.colorList=Settings.colorList||this.defaultColorList;
this.intervalList=Settings.intervalList||this.defaultIntervalList},open:function(a){var b=a.getStyle(),c={currentColor:b.getColor(),colorList:this.colorList,zeroScaled:a.isZeroScaled(),groupedAxis:a.isGroupedAxis()};b.isBarChart()&&(c.bar=!0,c.interval=this.intervalList);Modal.show("style-change",c);$(".colorButton").on("click",function(c){c=$(c.target).data("color");b.getColor()!=c&&(b.setColor(c),EventManager.publish("timeseries:changeStyle",a))});$(".intervalButton").on("click",function(c){c=$(c.target).data("interval");
b.getIntervalByHours()!=c&&(b.setIntervalByHours(c),EventManager.publish("timeseries:changeStyle",a))});$(".zeroScaled").on("click",function(b){b=Button.switchToggleButton(b.target);a.setZeroScaled(b);EventManager.publish("timeseries:zeroScaled",a)});$(".groupedAxis").on("click",function(b){b=Button.switchToggleButton(b.target);a.setGroupedAxis(b);EventManager.publish("timeseries:groupedAxis",a)})}},TableController={isVisible:!1,pageStart:0,pageSize:Settings.pagesize||10,init:function(){this.tableButton=
$('[data-action\x3d"dataTable"]');this.tableView=$("#tableView");this.tableButton.show();this.tableButton.on("click",$.proxy(function(a){a=$(a.currentTarget);var b=$('[data-toggle\x3d"legend"]');!1==this.isVisible?(this.isVisible=!0,this.tableView.show(),Button.setNewIcon(a,"glyphicon-stats"),b.hide(),EventManager.publish("navigation:open","table")):(this.isVisible=!1,this.tableView.hide(),b.show(),Button.removeNewIcon(a,"glyphicon-stats"),EventManager.publish("navigation:close","table"))},this));
EventManager.subscribe("navigation:open",$.proxy(this.createTable,this));EventManager.subscribe("timeseries:synced",$.proxy(this.createTable,this));EventManager.subscribe("timeseries:remove",$.proxy(this.createTable,this));EventManager.subscribe("timeseries:changeStyle",$.proxy(this.updateTable,this))},createTable:function(){this.isVisible&&(this.tableView.empty(),this.sortingFunc=null,this.pageStart=0,this.createHtmlTableHeader(),this.tableView.append(this.htmltable),this.updateTable(),this.createHeaderClickHandler())},
updateTable:function(){if(this.isVisible){var a=this.createValueArray();this.sortingFunc&&a.sort(this.sortingFunc);if(0<a.length){var b=this.createColorArray();this.createHtmlTable(a,b)}this.createPaging(a.length,this.pageSize,this.pageStart);this.createPagingClickHandler(a.length)}},createHeaderClickHandler:function(){$(".table th").on("click",$.proxy(function(a){a=$(a.currentTarget);var b=a.data("index");a.hasClass("sortedUp")?(a.removeClass("sortedUp").addClass("sortedDown"),this.changeSortLabel(a,
!1),this.sortingFunc=this.downsort(b)):(a.hasClass("sortedDown")?a.removeClass("sortedDown").addClass("sortedUp"):($(".table th").removeClass("sortedUp").removeClass("sortedDown"),a.addClass("sortedUp")),this.changeSortLabel(a,!0),this.sortingFunc=this.upsort(b));this.updateTable()},this))},changeSortLabel:function(a,b){$("#sorting").remove();var c=$("\x3cspan\x3e").attr("id","sorting");b?c.html("\x26nbsp;\x26#x25BE;"):c.html("\x26nbsp;\x26#x25B4;");a.append(c)},createPagingClickHandler:function(a){$(".pagination li a").on("click",
$.proxy(function(b){b=$(b.target).data("start");"undefined"!==typeof b&&0<=b&&b<=a&&(this.pageStart=b,this.updateTable())},this))},createPaging:function(a,b,c){this.tableView.find("div.paging").remove();var d=$('\x3cdiv class\x3d"paging"\x3e\x3c/div\x3e'),e=$('\x3cul class\x3d"pagination"\x3e\x3c/ul\x3e');e.append(this.pageButton("\x26laquo;",0));e.append(this.pageButton("\x26lsaquo;",c-b));e.append(this.pageButton(Math.ceil((c+1)/b)+"/"+Math.ceil(a/b)));e.append(this.pageButton("\x26rsaquo;",c+b));
e.append(this.pageButton("\x26raquo;",Math.floor(a/b)*b));d.append(e);this.tableView.append(d)},pageButton:function(a,b){var c=$("\x3cli\x3e\x3c/li\x3e"),d=$("\x3ca\x3e"+a+"\x3c/a\x3e");d.data("start",b);c.append(d);return c},createColorArray:function(){var a=[];$.each(TimeSeriesController.getTimeseriesCollection(),function(b,c){a.push(c.getStyle().getColor())});return a},createValueArray:function(){var a=[];$.each(TimeSeriesController.getTimeseriesCollection(),function(b,c){var d=c.getValues(),e=
null!=a[0]&&0<a[0].length?a[0].length:0,f=0;$.each(d,function(b,c){var d=c[0],k=c[1];if(0==e)a.push([d,k]);else{for(;null!=a[f]&&a[f][0]<d;)a[f][e]="-",f++;if(null!=a[f]&&a[f][0]==d)a[f][e]=k;else{var l=[];l.push(d);for(d=1;d<e;d++)l.push("-");l.push(k);a.splice(f,0,l)}f++}})});return a},upsort:function(a){return function(b,c){return isNaN(b[a])&&isNaN(c[a])?0:isNaN(b[a])?-1:isNaN(c[a])?1:b[a]-c[a]}},downsort:function(a){return function(b,c){return isNaN(b[a])&&isNaN(c[a])?0:isNaN(b[a])?1:isNaN(c[a])?
-1:c[a]-b[a]}},createHtmlTableHeader:function(){this.htmltable=$("\x3ctable\x3e\x3c/table\x3e").addClass("table").addClass("table-condensed");var a=$("\x3cthead\x3e\x3c/thead\x3e"),b=$("\x3ctr\x3e\x3c/tr\x3e");b.append($("\x3cth\x3e\x3c/th\x3e").data("index",0).text("Time"));var c=1;$.each(TimeSeriesController.getTimeseriesCollection(),function(a,e){var f=$("\x3cdiv\x3e\x3c/div\x3e").text(e.getStationLabel()),g=$("\x3cspan\x3e\x3c/span\x3e").text(e.getPhenomenonLabel()+" ("+e.getUom()+")"),m=$("\x3cdiv\x3e\x3c/div\x3e").text(e.getCategoryLabel());
b.append($("\x3cth\x3e\x3c/th\x3e").data("index",c++).append(f).append(g).append(m))});this.htmltable.append(a.append(b))},createHtmlTable:function(a,b){this.htmltable.find("tbody tr").remove();$.each(a,$.proxy(function(a,d){if(!(a<this.pageStart||a>=this.pageStart+this.pageSize)){var e=$("\x3ctr\x3e\x3c/tr\x3e");$.each(d,function(a,c){0==a?e.append($("\x3ctd\x3e\x3c/td\x3e").text(moment(c).format(Settings.dateformat))):e.append($("\x3ctd\x3e\x3c/td\x3e").css("color",b[a-1]).append($("\x3cb\x3e\x3c/b\x3e").text(c)))});
this.htmltable.append(e)}},this));return this.htmltable}},ExportController={init:function(){var a=this.msieversion();(!a||9<a)&&EventManager.subscribe("timeseries:add",$.proxy(this.loadTimeseries,this))},loadTimeseries:function(a,b){tsId=b.getInternalId();var c=$('\x3cdiv class\x3d"additionalLegendEntry"\x3e\x3cspan class\x3d"glyphicon glyphicon-download"\x3e\x3c/span\x3e\x3cspan\x3e '+_("export.label")+"\x3c/span\x3e\x3c/div\x3e");$('.legendItem[data-id\x3d"'+tsId+'"]').find(".collapseLegendEntry").append(c);
c.on("click",$.proxy(function(){this.createCSVforTS(b)},this))},createCSVforTS:function(a){var b="Sensor Station;Sensor Phenomenon;Date;Value\n";$.each(a.getValues(),function(c,d){b+=a.getStationLabel()+";";b+=a.getPhenomenonLabel()+" ("+a.getUom()+");";b+=moment(d[0]).format()+";";b+=d[1];b+="\n"});this.triggerDownload(b,a.getLabel())},triggerDownload:function(a,b){var c=b;c||(c="export.csv");-1==c.indexOf(".csv")&&(c+=".csv");if(navigator.msSaveBlob){var d=new Blob([a],{type:"text/csv;charset\x3dutf-8;"});
navigator.msSaveBlob(d,c)}else d=document.createElement("a"),d.href="data:attachment/csv,"+encodeURI(a),d.target="_blank",d.download=c,document.body.appendChild(d),d.click()},msieversion:function(){var a=window.navigator.userAgent,b=a.indexOf("MSIE ");if(0<b)return parseInt(a.substring(b+5,a.indexOf(".",b)))}},GuidedTourController=function(){var a=function(b,c){!c.hasData()&&c.getLastValue().timestamp?EventManager.publish("time:end:change",c.getLastValue().timestamp):(EventManager.unsubscribe("timeseries:data:loadfinished",
a),this.showNext())},b=function(){EventManager.unsubscribe("map:stationLoaded",b);setTimeout($.proxy(function(){this.showNext()},this),200)},c=[{anchor:".navbar-header.chart",title:_("guide.step1.header"),text:_("guide.step1.text"),initStep:function(){Pages.navigateToChart()}},{anchor:'[data-target\x3d"#map"]',title:_("guide.step2.header"),text:_("guide.step2.text"),arrow:!0,initStep:function(){Pages.navigateToChart()}},{anchor:".navbar-header.map",title:_("guide.step3.header"),text:_("guide.step3.text"),
initStep:function(){Pages.navigateToMap()}},{anchor:'[data-action\x3d"provider"]',title:_("guide.step4.header"),text:_("guide.step4.text"),arrow:!0,initStep:function(){}},{anchor:'[data-action\x3d"locate"]',title:_("guide.step5.header"),text:_("guide.step5.text"),arrow:!0,initStep:function(){}},{anchor:'[data-action\x3d"listSelection"]',title:_("guide.step6.header"),text:_("guide.step6.text"),arrow:!0,initStep:function(){}},{anchor:".navbar-header.map",title:_("guide.step7.header"),text:_("guide.step7.text"),
next:!1,initStep:function(a){EventManager.subscribe("map:stationLoaded",$.proxy(b,a))}},{anchor:".tsItem input",title:_("guide.step8.header"),text:_("guide.step8.text"),previous:!1,next:!1,arrow:!0,initStep:function(b){EventManager.subscribe("timeseries:data:loadfinished",$.proxy(a,b))}},{anchor:".legend-entry",title:_("guide.step9.header"),text:_("guide.step9.text"),arrow:!0,previous:!1,initStep:function(){Pages.toggleLegend(!0)}},{anchor:".navbar-header.chart",title:_("guide.step10.header"),text:_("guide.step10.text"),
initStep:function(){Pages.toggleLegend(!1)}},{anchor:".btn-group.timeSelection",title:_("guide.step11.header"),text:_("guide.step11.text"),arrow:!0,initStep:function(){}},{anchor:'[data-action\x3d"dataTable"]',title:_("guide.step12.header"),text:_("guide.step12.text"),arrow:!0,initStep:function(){}},{anchor:'[data-target\x3d"#favorites"]',title:_("guide.step13.header"),text:_("guide.step13.text"),arrow:!0,initStep:function(){}},{anchor:".navbar-header.chart",title:_("guide.step14.header"),text:_("guide.step14.text"),
initStep:function(){}}];return{init:function(){$(document).ready(function(){$('[data-target\x3d"#tour"]').click(function(){GuidedTourController.start()})});"true"===Permalink.getUrlParameter("tour")&&GuidedTourController.start()},start:function(){this.closeLast();this.show(1);Status.reset()},showNext:function(){this.closeLast();this.show(this.idx+1)},closeLast:function(){this.gtWindow&&this.gtWindow.popover("destroy")},show:function(a){this.idx=a;var b=c[a-1];b.initStep(this);this.gtWindow=$(b.anchor+
":first").popover({html:!0,template:b.arrow?'\x3cdiv class\x3d"popover guidedtour"\x3e\x3cdiv class\x3d"arrow"\x3e\x3c/div\x3e\x3cdiv class\x3d"popover-content"\x3e\x3c/div\x3e\x3c/div\x3e':'\x3cdiv class\x3d"popover guidedtour"\x3e\x3cdiv class\x3d"popover-content"\x3e\x3c/div\x3e\x3c/div\x3e',trigger:"manual",content:Template.createHtml("guidedtour",{title:b.title,text:b.text,previous:1<=a-1&&!1!=b.previous?a-1:null,step:a,next:a+1<=c.length&&!1!=b.next?a+1:null,steps:c.length}),placement:"auto"});
$(b.anchor).popover("show");$(".paging.guidedtour li a").on("click",$.proxy(function(a){a=parseInt(a.currentTarget.dataset.step);isNaN(a)||(this.closeLast(),this.show(a))},this));$(".guidedtour .close").on("click",$.proxy(function(){this.closeLast()},this));this.gtWindow.on("hidden.bs.popover",$.proxy(function(){this.closeLast()},this))}}}(),FavoriteController={favorites:{},groupIdx:0,favoriteGroups:{},init:function(){this.key=Storage.generateKey("favorites");this.favoriteButton=$(".favoriteButton");
this.favoriteButton.show();this.favoriteButton.on("click",$.proxy(function(a){this.showFavoritesView()},this));this.createFavoritesListView();this.activateImportExportHandlers();EventManager.subscribe("timeseries:add",$.proxy(this.addLegendStar,this));EventManager.subscribe("timeseries:changeStyle",$.proxy(this.addLegendStar,this));EventManager.subscribe("map:stationLoaded",$.proxy(this.addStationStar,this));EventManager.subscribe("settings:opened",$.proxy(function(){var a=$(Template.createHtml("favorite-settings-button"));
$("#accordionSettings .permalink .panel-body").append(a);a.on("click",$.proxy(function(){if(0<Object.keys(TimeSeriesController.timeseries).length)if(this.isInFavoriteGroup(TimeSeriesController.timeseries))NotifyController.notify(_("favorite.group.exists"));else{var a=this.addFavoriteGroup(TimeSeriesController.timeseries);this.saveFavorites();NotifyController.notify(_("favorite.group.add").replace("{0}",a))}else NotifyController.notify(_("favorite.group.noTimeseries"))},this))},this));this.loadFavorites()},
navigateToFavoritesView:function(){Pages.navigateToPage("#favorite-page");Pages.toggleLegend(!1);Pages.togglePhenomenon(!1)},clearFavoritesView:function(){$(".favoriteslist").empty()},updateFavoritesView:function(){this.clearFavoritesView();$.each(this.favorites,$.proxy(function(a,b){this.drawFavorite(b)},this));$.each(this.favoriteGroups,$.proxy(function(a,b){this.drawFavoriteGroup(b,a)},this))},drawFavorite:function(a){var b=a.timeseries,c=b.getLastValue();a=Template.createHtml("favorite-entry",
{id:b.getInternalId(),label:a.label,provider:b.getServiceLabel(),lastValueTimeFormatted:c?moment(c.timestamp).format(Settings.dateformat):"",lastValue:c.value||"",uom:b.getUom()||""});$(".favoriteslist").append(a);this.addFavoriteClickEvent(b.getInternalId())},drawFavoriteGroup:function(a,b){var c=Template.createHtml("favorite-group-entry",{id:b,label:a.label,collection:$.map(a.collection,function(a){var b=a.getLastValue();return{label:a.getLabel(),lastValueTimeFormatted:b?moment(b.timestamp).format(Settings.dateformat):
"",lastValue:b.value||"",uom:a.getUom()||""}})});$(".favoriteslist").append(c);this.addGroupClickEvents(b)},showFavoritesView:function(){this.navigateToFavoritesView()},addFavoriteClickEvent:function(a){this.addClickEvents(a,"single-id","delete",$.proxy(function(b){this.removeFavorite(a);this.saveFavorites()},this));this.addClickEvents(a,"single-id","edit",$.proxy(function(b){this.openEditWindow(this.favorites[a])},this));this.addClickEvents(a,"single-id","addToDiagram",$.proxy(function(b){b=this.favorites[a];
Pages.navigateToChart();TimeSeriesController.addTS(b.timeseries)},this))},addGroupClickEvents:function(a){this.addClickEvents(a,"group-id","delete",$.proxy(function(b){delete this.favoriteGroups[a];$("[data-group-id\x3d"+a+"]").remove();this.saveFavorites()},this));this.addClickEvents(a,"group-id","edit",$.proxy(function(b){this.openEditWindow(this.favoriteGroups[a])},this));this.addClickEvents(a,"group-id","addToDiagram",$.proxy(function(b){b=this.favoriteGroups[a];Pages.navigateToChart();$.each(b.collection,
function(a,b){TimeSeriesController.addTS(b)})},this))},addClickEvents:function(a,b,c,d){$("[data-"+b+"\x3d"+a+"] ."+c).on("click",d)},openEditWindow:function(a){Modal.show("favorite-edit",{label:a.label});$("#confirmFavoritEdit").on("click",$.proxy(function(b){a.label=$("#favoriteLabel")[0].value;this.saveFavorites();this.updateFavoritesView()},this))},createFavoritesListView:function(){var a=Template.createHtml("favorites-main");$(".swc-main").append(a);Pages.activateNavButtonsHandler()},activateImportExportHandlers:function(){var a=
$("#favorites-file-import"),b=$("#favorites-file-export");a.change($.proxy(this.importFavorites,this));b.click($.proxy(this.exportFavorites,this))},createEmptyStar:function(){return $('\x3cspan class\x3d"glyphicon glyphicon-star-empty star"\x3e\x3c/span\x3e')},createFilledStar:function(){return $('\x3cspan class\x3d"glyphicon glyphicon-star star"\x3e\x3c/span\x3e')},addLegendStar:function(a,b){var c=b.getInternalId();$('.legendItem[data-id\x3d"'+c+'"]').find(".legendItemLabel .star").remove();var d,
e;this.favorites.hasOwnProperty(c)?(d=this.createFilledStar(),e=$.proxy(function(a){a.stopPropagation();a=this.removeFavorite(b);NotifyController.notify(_("favorite.single.remove").replace("{0}",a))},this)):(d=this.createEmptyStar(),e=$.proxy(function(a){a.stopPropagation();a=this.addFavorite(b);NotifyController.notify(_("favorite.single.add").replace("{0}",a))},this));$('.legendItem[data-id\x3d"'+c+'"]').find(".legendItemLabel").append(d);d.on("click",e)},addStationStar:function(){$.each($(".stationContent .tsItem"),
$.proxy(function(a,b){var c,d,e=b.dataset.internalid;$(b).find(".checkbox .star").remove();this.favorites.hasOwnProperty(e)?(c=this.createFilledStar(),d=$.proxy(function(a){a.stopPropagation();a=this.removeFavorite(e);NotifyController.notify(_("favorite.single.remove").replace("{0}",a));this.addStationStar()},this)):(c=this.createEmptyStar(),d=$.proxy(function(a){a.stopPropagation();Rest.timeseries(b.dataset.id,Status.get("provider").apiUrl).done($.proxy(function(a){a=this.addFavorite(a);NotifyController.notify(_("favorite.single.add").replace("{0}",
a));this.addStationStar()},this))},this));$(b).find(".checkbox label").after(c);c.on("click",d)},this))},addFavorite:function(a,b){b=this.addFavoriteToList(a,b);this.addLegendStar(null,a);return b},removeFavorite:function(a){a instanceof TimeSeries||(a=this.favorites[a].timeseries);var b=a.getInternalId(),c=this.favorites[b].label;delete this.favorites[b];$("[data-single-id\x3d"+b+"]").remove();this.addLegendStar(null,a);return c},addFavoriteToList:function(a,b){b=b||a.getLabel();this.favorites[a.getInternalId()]=
{label:b,timeseries:a};this.saveFavorites();this.drawFavorite(this.favorites[a.getInternalId()]);return b},hasFavorites:function(){return 0!==Object.getOwnPropertyNames(this.favorites).length},addFavoriteGroup:function(a,b){b=b||"Status "+this.groupIdx;this.favoriteGroups[this.groupIdx]={label:b,collection:$.map(a,function(a,b){return a})};this.saveFavorites();this.drawFavoriteGroup(this.favoriteGroups[this.groupIdx],this.groupIdx);this.groupIdx++;return b},isInFavoriteGroup:function(a){var b=!1;
$.each(this.favoriteGroups,function(c,d){var e=!0;d.collection.length===Object.keys(a).length?$.each(d.collection,function(b,c){var d=!1;$.each(a,function(a){a===c.getInternalId()&&(d=!0)});d||(e=!1)}):e=!1;e&&(b=!0)});return b},saveFavorites:function(){var a=this.serializeFavorites();Storage.saveObject(this.key,a)},loadFavorites:function(){var a=Storage.load(this.key);this.unserializeFavorites(a)},unserializeFavorites:function(a){a&&($.each(a.single,$.proxy(function(a,c){var d=c.timeseries;if(this.isSupported(d)){var e=
this;Rest.timeseries(d.tsId,d.apiUrl).done(function(a){e.addFavorite(a,c.label)})}else NotifyController.notify(_("favorite.single.notSupported").replace("{0}",c.label))},this)),$.each(a.groups,$.proxy(function(a,c){var d=c.label,e=$.map(c.collection,$.proxy(function(a){if(this.isSupported(a))return Rest.timeseries(a.tsId,a.apiUrl);NotifyController.notify(_("favorite.group.notSupported").replace("{0}",d))},this));$.when.apply(null,e).done($.proxy(function(){debugger;this.addFavoriteGroup(arguments,
d)},this))},this)))},isSupported:function(a){var b=!1;$.each(Settings.restApiUrls,function(c,d){a.apiUrl===c&&(b=!0)});return b},serializeFavorites:function(){return{single:$.map(this.favorites,function(a,b){return{label:a.label,timeseries:a.timeseries.persist()}}),groups:$.map(this.favoriteGroups,function(a,b){return{label:a.label,collection:$.map(a.collection,function(a,b){return a.persist()})}})}},exportFavorites:function(){if(this.isFileAPISupported()){var a=JSON.stringify(this.serializeFavorites());
if(window.navigator.msSaveBlob)a=new Blob([a],{type:"application/json;charset\x3dutf-8;"}),window.navigator.msSaveBlob(a,"favorites.json");else{var b=document.createElement("a");b.href="data:application/json,"+encodeURI(a);b.target="_blank";b.download="favorites.json";document.body.appendChild(b);b.click()}}else Inform.warn("The File APIs are not fully supported in this browser.")},importFavorites:function(a){if(this.isFileAPISupported()){var b=!0;this.hasFavorites()&&(b=confirm("Override favorites?"));
if(b&&(this.favorites={},this.clearFavoritesView(),(a=a.target.files)&&0<a.length)){b=new FileReader;b.readAsText(a[0]);b.onerror=function(){Inform.error("Could not read file!")};var c=this;b.onload=function(a){a=JSON.parse(a.target.result);c.unserializeFavorites(a);c.saveFavorites()}}}else Inform.warn("The File APIs are not fully supported in this browser.")},isFileAPISupported:function(){return window.File&&window.FileReader&&window.Blob}},NotifyController={options:{position:"bottom-left",fade_in_speed:"medium",
fade_out_speed:2E3,time:4E3},init:function(){$.extend($.gritter.options,this.options)},notify:function(a){$.gritter.add({text:a})}};